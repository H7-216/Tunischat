<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H7 Social - Plateforme de Communication Moderne</title>
    <meta name="description" content="H7 Social est une plateforme de communication moderne qui connecte les utilisateurs en temps réel. Échangez, partagez et collaborez en toute simplicité.">
    
    <!-- Open Graph -->
    <meta property="og:title" content="H7 Social - Communication en Temps Réel">
    <meta property="og:description" content="Rejoignez H7 Social pour discuter avec la communauté en temps réel, envoyer des messages privés et rester connecté avec vos amis.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=630">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, push, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
      import { getAuth, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBmMSD2SwHt-zF_YZHPEs6-03IlLGnO1CM",
        authDomain: "chat-2026-671bb.firebaseapp.com",
        databaseURL: "https://chat-2026-671bb-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "chat-2026-671bb",
        storageBucket: "chat-2026-671bb.firebasestorage.app",
        messagingSenderId: "767585260701",
        appId: "1:767585260701:web:9159e8293d385415f87074",
        measurementId: "G-8ZHZV3QQDH"
      };

      const app = initializeApp(firebaseConfig);
      window.database = getDatabase(app);
      window.auth = getAuth(app);
      window.googleProvider = new GoogleAuthProvider();
      window.firebaseRefs = { ref, push, onValue, off };
    </script>
    
    <style>
        :root {
            --primary: #3B82F6;
            --secondary: #8B5CF6;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .chat-message {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 60;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 16px;
            max-width: 300px;
            border-left: 4px solid #3B82F6;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            border-left-color: #EF4444;
        }
        
        .toast.success {
            border-left-color: #10B981;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Application Container -->
    <div id="app" class="min-h-screen">
        <!-- Landing Page -->
        <div id="landing-page" class="min-h-screen bg-gray-50">
            <!-- Hero Section -->
            <div class="relative min-h-screen bg-cover bg-center flex items-center justify-center" 
                 style="background-image: url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080')">
                <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                <div class="relative z-10 text-center text-white max-w-4xl px-6">
                    <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-8">
                        <i class="fas fa-comments text-white text-3xl"></i>
                    </div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-6">H7 Social</h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90">
                        La plateforme de communication moderne qui connecte les utilisateurs en temps réel
                    </p>
                    <button onclick="showAuthModal()" 
                            class="gradient-bg text-white px-8 py-4 rounded-lg text-lg font-semibold hover-scale shadow-xl">
                        Rejoindre la communauté
                    </button>
                </div>
            </div>

            <!-- Features Section -->
            <div class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Fonctionnalités</h2>
                        <p class="text-xl text-gray-600">Tout ce dont vous avez besoin pour communiquer efficacement</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-users text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Chat Public</h3>
                            <p class="text-gray-600">Discutez avec tous les membres de la communauté en temps réel</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-comment-dots text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Messages Privés</h3>
                            <p class="text-gray-600">Échangez en privé avec vos contacts préférés</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-bolt text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Temps Réel</h3>
                            <p class="text-gray-600">Recevez et envoyez des messages instantanément</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-gray-900 text-white mt-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <!-- Brand Section -->
                        <div class="col-span-1 lg:col-span-2">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                                    <i class="fas fa-comments text-white text-xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold">H7 Social</h3>
                            </div>
                            <p class="text-gray-300 max-w-md mb-6">
                                La plateforme de communication moderne qui connecte les utilisateurs en temps réel. 
                                Échangez, partagez et collaborez en toute simplicité.
                            </p>
                            <div class="flex space-x-4">
                                <a href="https://t.snapchat.com/XuhVH62f" target="_blank" rel="noopener noreferrer"
                                   class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center hover:bg-yellow-600 transition-colors">
                                    <i class="fab fa-snapchat-ghost text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                                    <i class="fab fa-facebook-f text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center hover:bg-pink-700 transition-colors">
                                    <i class="fab fa-instagram text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-400 rounded-lg flex items-center justify-center hover:bg-blue-500 transition-colors">
                                    <i class="fab fa-twitter text-white"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Quick Links -->
                        <div>
                            <h4 class="font-semibold text-lg mb-4">Liens Rapides</h4>
                            <ul class="space-y-2">
                                <li>
                                    <button onclick="showModal('about')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-info-circle mr-2"></i>À propos de nous
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('features')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-star mr-2"></i>Fonctionnalités
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('help')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-question-circle mr-2"></i>Centre d'aide
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('blog')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-blog mr-2"></i>Blog
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Legal Links -->
                        <div>
                            <h4 class="font-semibold text-lg mb-4">Légal</h4>
                            <ul class="space-y-2">
                                <li>
                                    <button onclick="showModal('privacy')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-shield-alt mr-2"></i>Confidentialité
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('terms')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-file-contract mr-2"></i>CGV
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('cookies')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-cookie-bite mr-2"></i>Cookies
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('contact')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-envelope mr-2"></i>Nous contacter
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Bottom Bar -->
                <div class="border-t border-gray-800">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <p class="text-gray-400 text-sm">
                                © 2025 H7 Social. Tous droits réservés.
                            </p>
                            <div class="flex items-center space-x-6 mt-4 md:mt-0">
                                <span class="text-gray-400 text-sm">Développé avec ❤️ par l'équipe H7</span>
                                <div class="flex items-center space-x-2">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    <span class="text-sm text-green-400">Serveurs opérationnels</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Chat Application -->
        <div id="chat-app" class="hidden min-h-screen bg-gray-50">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <!-- Logo and Brand -->
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                                <i class="fas fa-comments text-white text-lg"></i>
                            </div>
                            <h1 class="text-xl font-bold text-gray-900">H7 Social</h1>
                            <div class="hidden md:flex items-center space-x-2 ml-8">
                                <span id="connection-status" class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span id="online-count" class="text-sm text-gray-600">0 utilisateur en ligne</span>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex items-center space-x-4">
                            <button id="public-chat-btn" onclick="switchView('public')" 
                                    class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-blue-500 text-white">
                                <i class="fas fa-users"></i>
                                <span class="hidden sm:inline">Chat Public</span>
                            </button>
                            <button id="private-chat-btn" onclick="switchView('private')" 
                                    class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                                <i class="fas fa-comment-dots"></i>
                                <span class="hidden sm:inline">Messages Privés</span>
                            </button>
                            <button onclick="logout()" 
                                    class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="hidden sm:inline">Déconnexion</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Sidebar -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="font-semibold text-lg mb-4 text-gray-900">Utilisateurs Connectés</h3>
                        <div id="online-users" class="space-y-3"></div>
                        
                        <div id="offline-users-section" class="mt-6 pt-4 border-t border-gray-200">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Utilisateurs Hors Ligne</h4>
                            <div id="offline-users" class="space-y-2"></div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="mt-6 gradient-bg rounded-xl p-6 text-white">
                            <h4 class="font-semibold mb-3">Statistiques</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Messages aujourd'hui:</span>
                                    <span id="daily-messages">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Utilisateurs actifs:</span>
                                    <span id="active-users-count">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Fichiers partagés:</span>
                                    <span id="shared-files">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="lg:col-span-3">
                        <!-- Public Chat -->
                        <div id="public-chat" class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="border-b border-gray-200 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-xl font-semibold text-gray-900">Chat Public</h2>
                                        <p class="text-sm text-gray-600">Discutez avec tous les membres connectés</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                        <span id="message-count" class="text-sm text-gray-600">0 messages</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Messages Container -->
                            <div id="messages-container" class="h-96 overflow-y-auto p-6 space-y-4">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-comments text-4xl mb-4 opacity-50"></i>
                                    <p>Aucun message pour le moment. Commencez la conversation !</p>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="border-t border-gray-200 p-4">
                                <!-- Attachments preview -->
                                <div id="attachments-preview" class="hidden mb-4 flex flex-wrap gap-2"></div>
                                
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <textarea id="message-input" placeholder="Tapez votre message..." 
                                                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                  rows="2" onkeypress="handleKeyPress(event)"></textarea>
                                    </div>
                                    <div class="flex flex-col space-y-2">
                                        <input id="file-input" type="file" class="hidden" multiple 
                                               accept="image/*,video/*,.pdf,.doc,.docx,.txt" onchange="handleFileSelect(event)">
                                        <button onclick="document.getElementById('file-input').click()" 
                                                class="p-3 text-gray-500 hover:text-blue-500 transition-colors">
                                            <i id="file-icon" class="fas fa-paperclip text-lg"></i>
                                        </button>
                                        <button onclick="sendMessage()" 
                                                class="gradient-bg text-white p-3 rounded-lg hover-scale">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Private Chat -->
                        <div id="private-chat" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 h-96 flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-user-friends text-4xl mb-4 opacity-50"></i>
                                <p>Sélectionnez un utilisateur pour commencer une conversation privée</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Authentication Modal -->
        <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="absolute inset-0 bg-cover bg-center opacity-20" 
                 style="background-image: url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080')"></div>
            
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 relative z-10">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comments text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">H7 Social</h2>
                    <p class="text-gray-600">Connectez-vous pour rejoindre la communauté</p>
                </div>

                <form id="auth-form" onsubmit="handleAuth(event)">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                            <input type="text" id="username" placeholder="Votre nom d'utilisateur" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Code d'accès</label>
                            <input type="password" id="password" placeholder="Votre code d'accès" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        </div>

                        <div id="confirm-password-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirmez le code</label>
                            <input type="password" id="confirm-password" placeholder="Confirmez votre code"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                        </div>

                        <div id="profile-image-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Photo de profil (optionnel) ❤️</label>
                            <div class="flex items-center space-x-4">
                                <div id="profile-preview" class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                                    <i class="fas fa-user text-gray-400 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="profile-image" accept="image/*" class="hidden" onchange="handleProfileImageSelect(event)">
                                    <button type="button" onclick="document.getElementById('profile-image').click()" 
                                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                        <i class="fas fa-camera mr-2"></i>Choisir une photo
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1">JPG, PNG ou GIF (max 5MB)</p>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="auth-btn"
                                class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover-scale">
                            Se connecter
                        </button>
                    </div>
                </form>

                <div class="mt-6 text-center">
                    <button id="toggle-auth" onclick="toggleAuthMode()" 
                            class="text-blue-500 hover:text-blue-600 transition-colors">
                        Pas de compte ? Créer un compte
                    </button>
                </div>

                <button onclick="hideAuthModal()" 
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Generic Modal -->
        <div id="generic-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[80vh] mx-4 overflow-hidden">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-900"></h2>
                    <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="modal-content" class="overflow-y-auto p-6" style="max-height: calc(80vh - 120px);">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div id="toast-container"></div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global state
        let currentUser = null;
        let isConnected = false;
        let messages = [];
        let currentView = 'public';
        let attachments = [];
        let isLogin = true;
        let allUsers = []; // Seuls les utilisateurs réellement connectés

        // Firebase message handling
        function initializeFirebase() {
            if (!window.database || !currentUser) return;

            const messagesRef = window.firebaseRefs.ref(window.database, 'messages');
            const usersRef = window.firebaseRefs.ref(window.database, 'users');
            
            // Listen for new messages
            window.firebaseRefs.onValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    messages = Object.entries(data).map(([id, message]) => ({
                        id,
                        ...message,
                        timestamp: new Date(message.createdAt || Date.now())
                    }));
                    
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    displayMessages();
                } else {
                    messages = [];
                    displayMessages();
                }
            });

            // Listen for connected users in real-time
            window.firebaseRefs.onValue(usersRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    allUsers = Object.entries(data).map(([id, user]) => ({
                        id,
                        ...user
                    }));
                } else {
                    allUsers = [];
                }
                updateConnectionStatus();
            });

            // Add current user as online in Firebase
            const currentUserRef = window.firebaseRefs.ref(window.database, `users/${currentUser.id}`);
            const userData = {
                username: currentUser.username,
                isOnline: true,
                isAdmin: currentUser.username.toLowerCase() === 'h7' || currentUser.username.toLowerCase() === 'admin',
                profileImage: currentUser.profileImage || (currentUser.username.toLowerCase() === 'h7' ? 'https://seeklogo.com/images/C/cristiano-ronaldo-cr7-logo-D42A5A0A3E-seeklogo.com.png' : `https://images.unsplash.com/photo-${Math.floor(Math.random() * 1000000000)}-${Math.floor(Math.random() * 1000000000)}?w=150`),
                lastSeen: new Date().toISOString()
            };
            
            // Set user as online
            window.firebaseRefs.push(currentUserRef, userData);

            // Handle page unload to set user offline
            window.addEventListener('beforeunload', () => {
                const offlineData = {
                    ...userData,
                    isOnline: false,
                    lastSeen: new Date().toISOString()
                };
                window.firebaseRefs.push(currentUserRef, offlineData);
            });
            
            isConnected = true;
            updateConnectionStatus();
        }

        function sendFirebaseMessage(content, type = 'public', recipient = null) {
            if (!window.database || !currentUser || (!content.trim() && attachments.length === 0)) return;

            const messagesRef = window.firebaseRefs.ref(window.database, 'messages');
            const newMessage = {
                username: currentUser.username,
                content: content.trim(),
                createdAt: new Date().toISOString(),
                type: type,
                isPrivate: type === 'private',
                authorId: currentUser.username,
                ...(attachments.length > 0 && { attachments: [...attachments] }),
                ...(recipient && { recipientId: recipient })
            };

            window.firebaseRefs.push(messagesRef, newMessage);
        }

        // Authentication
        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }
        
        function toggleAuthMode() {
            isLogin = !isLogin;
            const confirmField = document.getElementById('confirm-password-field');
            const profileField = document.getElementById('profile-image-field');
            const authBtn = document.getElementById('auth-btn');
            const toggleBtn = document.getElementById('toggle-auth');
            const confirmInput = document.getElementById('confirm-password');
            const passwordInput = document.getElementById('password');
            
            if (isLogin) {
                confirmField.classList.add('hidden');
                profileField.classList.add('hidden');
                authBtn.textContent = 'Se connecter';
                toggleBtn.textContent = 'Pas de compte ? Créer un compte';
                confirmInput.removeAttribute('required');
                passwordInput.setAttribute('minlength', '1');
            } else {
                confirmField.classList.remove('hidden');
                profileField.classList.remove('hidden');
                authBtn.textContent = 'Créer un compte';
                toggleBtn.textContent = 'Déjà un compte ? Se connecter';
                confirmInput.setAttribute('required', '');
                passwordInput.setAttribute('minlength', '4');
            }
        }

        let selectedProfileImage = null;
        
        function handleProfileImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showToast('La taille du fichier ne peut pas dépasser 5MB', 'error');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showToast('Veuillez sélectionner une image valide', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedProfileImage = e.target.result;
                const preview = document.getElementById('profile-preview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Aperçu" class="w-full h-full object-cover rounded-full">`;
            };
            reader.readAsDataURL(file);
        }

        function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validation for registration
            if (!isLogin) {
                if (password.length < 4) {
                    showToast('Le code doit contenir au moins 4 caractères', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showToast('Les codes ne correspondent pas', 'error');
                    return;
                }
            }

            // Simple authentication for demo
            if (username && password) {
                currentUser = {
                    id: Date.now().toString(),
                    username: username,
                    isOnline: true,
                    profileImage: selectedProfileImage
                };
                
                localStorage.setItem('h7_user', JSON.stringify(currentUser));
                showToast(isLogin ? 'Connexion réussie!' : 'Compte créé avec succès!', 'success');
                hideAuthModal();
                showChatApp();
                initializeFirebase();
            }
        }

        function logout() {
            localStorage.removeItem('h7_user');
            currentUser = null;
            showLandingPage();
        }

        // View switching
        function showLandingPage() {
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('chat-app').classList.add('hidden');
        }

        function showChatApp() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
        }

        function switchView(view) {
            currentView = view;
            
            // Update button styles
            document.getElementById('public-chat-btn').className = 
                view === 'public' ? 
                'flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-blue-500 text-white' :
                'flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
                
            document.getElementById('private-chat-btn').className = 
                view === 'private' ? 
                'flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-blue-500 text-white' :
                'flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            // Show/hide chat areas
            document.getElementById('public-chat').classList.toggle('hidden', view !== 'public');
            document.getElementById('private-chat').classList.toggle('hidden', view !== 'private');
        }

        // Message handling
        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (content || attachments.length > 0) {
                sendFirebaseMessage(content, currentView);
                input.value = '';
                attachments = [];
                updateAttachmentsPreview();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function displayMessages() {
            const container = document.getElementById('messages-container');
            const publicMessages = messages.filter(msg => msg.type === 'public' || !msg.isPrivate);
            
            if (publicMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-comments text-4xl mb-4 opacity-50"></i>
                        <p>Aucun message pour le moment. Commencez la conversation !</p>
                    </div>
                `;
            } else {
                container.innerHTML = publicMessages.map(msg => `
                    <div class="chat-message flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">${msg.username.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-medium text-gray-900">${msg.username}</span>
                                <span class="text-xs text-gray-500">${formatTime(msg.timestamp)}</span>
                            </div>
                            ${msg.content ? `<p class="text-gray-700 mb-2">${msg.content}</p>` : ''}
                            ${msg.attachments && msg.attachments.length > 0 ? `
                                <div class="flex flex-wrap gap-2">
                                    ${msg.attachments.map((att, index) => `
                                        <div class="flex items-center space-x-2 bg-gray-100 px-2 py-1 rounded text-sm">
                                            <i class="fas ${
                                                att.type.startsWith('image/') ? 'fa-image' :
                                                att.type.includes('pdf') ? 'fa-file-pdf' :
                                                att.type.startsWith('video/') ? 'fa-video' :
                                                'fa-file'
                                            } text-gray-600"></i>
                                            <span class="text-gray-700">${att.name}</span>
                                            <button onclick="downloadFile('${att.url}', '${att.name}')" 
                                                    class="text-blue-500 hover:text-blue-700 ml-2">
                                                <i class="fas fa-download text-xs"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Update message count
            document.getElementById('message-count').textContent = `${publicMessages.length} message${publicMessages.length !== 1 ? 's' : ''}`;
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const countEl = document.getElementById('online-count');
            
            const onlineCount = allUsers.filter(u => u.isOnline).length;
            statusEl.className = `w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`;
            countEl.textContent = `${onlineCount} utilisateur${onlineCount > 1 ? 's' : ''} en ligne`;
            
            updateUsersList();
        }
        
        function updateUsersList() {
            const onlineContainer = document.getElementById('online-users');
            const offlineContainer = document.getElementById('offline-users');
            const offlineSection = document.getElementById('offline-users-section');
            const activeCount = document.getElementById('active-users-count');
            
            const onlineUsers = allUsers.filter(u => u.isOnline);
            const offlineUsers = allUsers.filter(u => !u.isOnline);
            
            // Update online users
            onlineContainer.innerHTML = onlineUsers.map(user => `
                <div onclick="selectUser('${user.id}')" 
                     class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                    <img src="${user.profileImage || (user.username.toLowerCase() === 'h7' ? 'https://seeklogo.com/images/C/cristiano-ronaldo-cr7-logo-D42A5A0A3E-seeklogo.com.png' : `https://images.unsplash.com/photo-${Math.floor(Math.random() * 1000000000)}-${Math.floor(Math.random() * 1000000000)}?w=150`)}" alt="Profil ${user.username}" 
                         class="w-10 h-10 rounded-full object-cover ${user.username.toLowerCase() === 'h7' ? 'border-2 border-yellow-400' : ''}">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">
                            ${user.username} ${user.isAdmin ? '(Admin) 👑' : ''}
                        </p>
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span class="text-xs text-green-600">En ligne</span>
                        </div>
                    </div>
                    ${user.isAdmin ? '<i class="fas fa-crown text-yellow-500"></i>' : ''}
                </div>
            `).join('');
            
            // Update offline users
            if (offlineUsers.length > 0) {
                offlineSection.classList.remove('hidden');
                offlineContainer.innerHTML = offlineUsers.map(user => `
                    <div onclick="selectUser('${user.id}')" 
                         class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <img src="${user.profileImage || (user.username.toLowerCase() === 'h7' ? 'https://seeklogo.com/images/C/cristiano-ronaldo-cr7-logo-D42A5A0A3E-seeklogo.com.png' : `https://images.unsplash.com/photo-${Math.floor(Math.random() * 1000000000)}-${Math.floor(Math.random() * 1000000000)}?w=150`)}" alt="Profil ${user.username}" 
                             class="w-8 h-8 rounded-full object-cover opacity-60 ${user.username.toLowerCase() === 'h7' ? 'border-2 border-yellow-400' : ''}">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-500 truncate">${user.username}</p>
                            <div class="flex items-center space-x-1">
                                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                <span class="text-xs text-gray-400">Hors ligne</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                offlineSection.classList.add('hidden');
            }
            
            // Update stats
            activeCount.textContent = onlineUsers.length;
            document.getElementById('daily-messages').textContent = messages.length;
            document.getElementById('shared-files').textContent = messages.filter(m => m.attachments && m.attachments.length > 0).length;
        }
        
        function selectUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user && user.isOnline) {
                showToast(`Conversation privée avec ${user.username}`, 'info');
                // Ici on pourrait ajouter la logique pour ouvrir le chat privé
            } else {
                showToast(`${user.username} est hors ligne`, 'error');
            }
        }
        
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Modal system
        function showModal(type) {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            const modalData = {
                about: {
                    title: 'À propos de H7 Social',
                    content: `
                        <div class="space-y-6">
                            <p class="text-gray-700 leading-relaxed">
                                H7 Social est une plateforme de communication moderne développée avec les dernières technologies web. 
                                Notre mission est de connecter les utilisateurs du monde entier grâce à une interface intuitive et des fonctionnalités innovantes.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-semibold text-lg mb-3">Notre Vision</h3>
                                    <p class="text-gray-600">Créer un espace numérique où chacun peut s'exprimer librement et se connecter avec des personnes partageant les mêmes intérêts.</p>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg mb-3">Nos Valeurs</h3>
                                    <ul class="text-gray-600 space-y-1">
                                        <li>• Respect et bienveillance</li>
                                        <li>• Innovation constante</li>
                                        <li>• Sécurité des données</li>
                                        <li>• Accessibilité pour tous</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                blog: {
                    title: 'Blog H7 Social',
                    content: `
                        <div class="space-y-6">
                            <article class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="text-xl font-semibold text-gray-900">Bienvenue sur H7 Social</h3>
                                    <span class="text-sm text-gray-500">15 Août 2025</span>
                                </div>
                                <p class="text-gray-600 mb-3">Découvrez comment H7 Social révolutionne la communication en temps réel.</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500">Par Équipe H7</span>
                                </div>
                            </article>
                            
                            <article class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="text-xl font-semibold text-gray-900">Nouvelles fonctionnalités</h3>
                                    <span class="text-sm text-gray-500">10 Août 2025</span>
                                </div>
                                <p class="text-gray-600 mb-3">Explorez les dernières améliorations apportées à la plateforme.</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500">Par Équipe H7</span>
                                </div>
                            </article>
                        </div>
                    `
                },
                contact: {
                    title: 'Nous contacter',
                    content: `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Contact Form -->
                            <div>
                                <h3 class="text-lg font-semibold mb-4">Envoyez-nous un message</h3>
                                <form onsubmit="submitContactForm(event)" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet</label>
                                        <input type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sujet</label>
                                        <input type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                                        <textarea rows="4" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                    </div>
                                    <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover-scale">
                                        Envoyer le message
                                    </button>
                                </form>
                            </div>

                            <!-- Contact Info -->
                            <div>
                                <h3 class="text-lg font-semibold mb-4">Autres moyens de contact</h3>
                                <div class="space-y-6">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-envelope text-white"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium">Email</h4>
                                            <p class="text-gray-600">contact@h7social.com</p>
                                        </div>
                                    </div>

                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center">
                                            <i class="fab fa-snapchat-ghost text-white"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium">Snapchat</h4>
                                            <a href="https://t.snapchat.com/XuhVH62f" target="_blank" rel="noopener noreferrer"
                                               class="text-blue-500 hover:text-blue-600">Contactez-nous sur Snapchat</a>
                                        </div>
                                    </div>

                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-clock text-white"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium">Horaires</h4>
                                            <p class="text-gray-600">Lun-Ven: 9h-18h<br>Sam-Dim: 10h-16h</p>
                                        </div>
                                    </div>

                                    <div class="p-4 gradient-bg rounded-lg text-white">
                                        <h4 class="font-medium mb-2">Support Premium</h4>
                                        <p class="text-sm opacity-90">Réponse garantie en moins de 2h pour les utilisateurs premium.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                privacy: {
                    title: 'Politique de confidentialité',
                    content: `
                        <div class="prose max-w-none">
                            <p>Votre vie privée est importante pour nous. Cette politique explique comment nous collectons, utilisons et protégeons vos informations personnelles.</p>
                            <h3>Collecte d'informations</h3>
                            <p>Nous collectons uniquement les informations nécessaires au fonctionnement de notre service.</p>
                            <h3>Utilisation des données</h3>
                            <p>Vos données sont utilisées exclusivement pour améliorer votre expérience utilisateur.</p>
                        </div>
                    `
                },
                terms: {
                    title: 'Conditions générales',
                    content: `
                        <div class="prose max-w-none">
                            <p>En utilisant H7 Social, vous acceptez les conditions suivantes :</p>
                            <h3>Utilisation du service</h3>
                            <p>Vous vous engagez à utiliser notre plateforme de manière respectueuse et légale.</p>
                            <h3>Responsabilités</h3>
                            <p>Vous êtes responsable du contenu que vous publiez sur notre plateforme.</p>
                        </div>
                    `
                },
                cookies: {
                    title: 'Politique des cookies',
                    content: `
                        <div class="prose max-w-none">
                            <p>Nous utilisons des cookies pour améliorer votre expérience de navigation.</p>
                            <h3>Types de cookies</h3>
                            <p>Cookies essentiels, analytiques et de préférences.</p>
                            <h3>Gestion des cookies</h3>
                            <p>Vous pouvez gérer vos préférences de cookies dans les paramètres de votre navigateur.</p>
                        </div>
                    `
                }
            };
            
            const data = modalData[type] || { title: 'Information', content: '<p>Contenu non disponible.</p>' };
            title.textContent = data.title;
            content.innerHTML = data.content;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('generic-modal').classList.add('hidden');
        }
        
        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${
                        type === 'error' ? 'fa-exclamation-circle text-red-500' :
                        type === 'success' ? 'fa-check-circle text-green-500' :
                        'fa-info-circle text-blue-500'
                    }"></i>
                    <span class="text-gray-800">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // File handling
        function handleFileSelect(event) {
            const files = Array.from(event.target.files || []);
            if (files.length === 0) return;
            
            const fileIcon = document.getElementById('file-icon');
            fileIcon.className = 'fas fa-spinner fa-spin text-lg';
            
            files.forEach(file => {
                // Simulate file upload for demo
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    url: URL.createObjectURL(file)
                };
                attachments.push(fileData);
            });
            
            updateAttachmentsPreview();
            showToast(`${files.length} fichier${files.length > 1 ? 's' : ''} ajouté${files.length > 1 ? 's' : ''}`, 'success');
            
            fileIcon.className = 'fas fa-paperclip text-lg';
            event.target.value = '';
        }
        
        function updateAttachmentsPreview() {
            const preview = document.getElementById('attachments-preview');
            
            if (attachments.length === 0) {
                preview.classList.add('hidden');
                preview.innerHTML = '';
                return;
            }
            
            preview.classList.remove('hidden');
            preview.innerHTML = attachments.map((attachment, index) => `
                <div class="flex items-center space-x-2 bg-gray-100 px-3 py-2 rounded-lg">
                    <i class="fas ${
                        attachment.type.startsWith('image/') ? 'fa-image' :
                        attachment.type.includes('pdf') ? 'fa-file-pdf' :
                        attachment.type.startsWith('video/') ? 'fa-video' :
                        'fa-file'
                    } text-gray-600"></i>
                    <span class="text-sm text-gray-700">${attachment.name}</span>
                    <button onclick="removeAttachment(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function removeAttachment(index) {
            attachments.splice(index, 1);
            updateAttachmentsPreview();
        }

        // Initialize app
        function initApp() {
            const savedUser = localStorage.getItem('h7_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // User will be added automatically via Firebase real-time listener
                
                showChatApp();
                initializeFirebase();
            } else {
                showLandingPage();
            }
        }
        
        function submitContactForm(event) {
            event.preventDefault();
            showToast('Message envoyé ! Nous vous répondrons dans les plus brefs délais.', 'success');
            hideModal();
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>