<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H7 Social - Plateforme de Communication Moderne</title>
    <meta name="description" content="H7 Social est une plateforme de communication moderne qui connecte les utilisateurs en temps réel. Échangez, partagez et collaborez en toute simplicité.">
    
    <!-- Open Graph -->
    <meta property="og:title" content="H7 Social - Communication en Temps Réel">
    <meta property="og:description" content="Rejoignez H7 Social pour discuter avec la communauté en temps réel, envoyer des messages privés et rester connecté avec vos amis.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #3B82F6;
            --secondary: #8B5CF6;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .chat-message {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 60;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 16px;
            max-width: 300px;
            border-left: 4px solid #3B82F6;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            border-left-color: #EF4444;
        }
        
        .toast.success {
            border-left-color: #10B981;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .avatar-upload-container {
            position: relative;
            display: inline-block;
        }
        
        .avatar-upload-button {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .config-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            max-width: 350px;
        }

        .admin-disconnect-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .admin-disconnect-btn:hover {
            background: #dc2626;
        }

        .admin-disconnect-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .h7-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Configuration Panel -->
    <div id="config-panel" class="config-panel hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Configuration Firebase</h3>
            <button onclick="toggleConfigPanel()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <input type="text" id="firebase-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Votre clé API Firebase">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Database URL</label>
                <input type="text" id="firebase-db-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="URL de votre base de données">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
                <input type="text" id="firebase-project-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="ID du projet">
            </div>
            <button onclick="saveFirebaseConfig()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">
                Sauvegarder et Connecter
            </button>
            <p class="text-xs text-gray-500">Ces informations sont stockées localement dans votre navigateur</p>
        </div>
    </div>

    <!-- Settings Button -->
    <button onclick="toggleConfigPanel()" 
            class="fixed top-4 left-4 z-50 bg-white p-3 rounded-full shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors">
        <i class="fas fa-cog text-gray-600"></i>
    </button>

    <!-- Application Container -->
    <div id="app" class="min-h-screen">
        <!-- Landing Page -->
        <div id="landing-page" class="min-h-screen bg-gray-50">
            <!-- Hero Section -->
            <div class="relative min-h-screen bg-cover bg-center flex items-center justify-center" 
                 style="background-image: url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080')">
                <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                <div class="relative z-10 text-center text-white max-w-4xl px-6">
                    <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-8">
                        <img src="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg" alt="H7 Logo" class="w-12 h-12 rounded-full object-cover">
                    </div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-6">H7 Social</h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90">
                        La plateforme de communication moderne qui connecte les utilisateurs en temps réel
                    </p>
                    <button onclick="showAuthModal()" 
                            class="gradient-bg text-white px-8 py-4 rounded-lg text-lg font-semibold hover-scale shadow-xl">
                        Rejoindre la communauté
                    </button>
                </div>
            </div>

            <!-- Features Section -->
            <div class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Fonctionnalités</h2>
                        <p class="text-xl text-gray-600">Tout ce dont vous avez besoin pour communiquer efficacement</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-users text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Chat Public</h3>
                            <p class="text-gray-600">Discutez avec tous les membres de la communauté en temps réel</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-comment-dots text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Messages Privés</h3>
                            <p class="text-gray-600">Échangez en privé avec vos contacts préférés</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-bolt text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Temps Réel</h3>
                            <p class="text-gray-600">Recevez et envoyez des messages instantanément</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-gray-900 text-white mt-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <!-- Brand Section -->
                        <div class="col-span-1 lg:col-span-2">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                                    <img src="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg" alt="H7 Logo" class="w-8 h-8 rounded-lg object-cover">
                                </div>
                                <h3 class="text-2xl font-bold">H7 Social</h3>
                            </div>
                            <p class="text-gray-300 max-w-md mb-6">
                                La plateforme de communication moderne qui connecte les utilisateurs en temps réel. 
                                Échangez, partagez et collaborez en toute simplicité.
                            </p>
                            <div class="flex space-x-4">
                                <a href="https://t.snapchat.com/XuhVH62f" target="_blank" rel="noopener noreferrer"
                                   class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center hover:bg-yellow-600 transition-colors">
                                    <i class="fab fa-snapchat-ghost text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                                    <i class="fab fa-facebook-f text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center hover:bg-pink-700 transition-colors">
                                    <i class="fab fa-instagram text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-400 rounded-lg flex items-center justify-center hover:bg-blue-500 transition-colors">
                                    <i class="fab fa-twitter text-white"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Quick Links -->
                        <div>
                            <h4 class="font-semibold text-lg mb-4">Liens Rapides</h4>
                            <ul class="space-y-2">
                                <li>
                                    <button onclick="showModal('about')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-info-circle mr-2"></i>À propos de nous
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('features')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-star mr-2"></i>Fonctionnalités
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('help')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-question-circle mr-2"></i>Centre d'aide
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('blog')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-blog mr-2"></i>Blog
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Legal Links -->
                        <div>
                            <h4 class="font-semibold text-lg mb-4">Légal</h4>
                            <ul class="space-y-2">
                                <li>
                                    <button onclick="showModal('privacy')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-shield-alt mr-2"></i>Confidentialité
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('terms')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-file-contract mr-2"></i>Conditions d'utilisation
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('cookies')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-cookie-bite mr-2"></i>Politique des cookies
                                    </button>
                                </li>
                                <li>
                                    <button onclick="showModal('contact')" 
                                            class="text-gray-300 hover:text-white transition-colors flex items-center">
                                        <i class="fas fa-envelope mr-2"></i>Contact
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="border-t border-gray-800 mt-12 pt-8 text-center text-gray-400">
                        <p>&copy; 2024 H7 Social. Tous droits réservés. | Développé avec ❤️ par l'équipe H7</p>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Chat Application -->
        <div id="chat-app" class="hidden min-h-screen bg-gray-50">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <!-- Logo et titre -->
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                                <img src="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg" alt="H7 Logo" class="w-6 h-6 rounded-md object-cover">
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">H7 Social</h1>
                                <div class="flex items-center space-x-2">
                                    <div id="connection-status" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                    <span id="server-status-text" class="text-xs text-gray-500">Déconnecté</span>
                                </div>
                            </div>
                        </div>

                        <!-- Actions utilisateur -->
                        <div class="flex items-center space-x-4">
                            <!-- État du serveur -->
                            <div id="server-status" class="hidden sm:flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium">
                                <div class="w-2 h-2 rounded-full"></div>
                                <span>Serveur</span>
                            </div>

                            <!-- Profil utilisateur -->
                            <div id="user-info" class="flex items-center space-x-3">
                                <div class="avatar-upload-container">
                                    <img id="user-avatar" src="" alt="Avatar" 
                                         class="w-10 h-10 rounded-full object-cover border-2 border-gray-200 cursor-pointer"
                                         onclick="openAvatarUpload()">
                                    <button onclick="openAvatarUpload()" class="avatar-upload-button" title="Changer l'avatar">
                                        <i class="fas fa-camera text-xs"></i>
                                    </button>
                                </div>
                                <div class="hidden sm:block">
                                    <p id="user-name" class="text-sm font-medium text-gray-900"></p>
                                    <p class="text-xs text-gray-500">En ligne</p>
                                </div>
                                <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
                            </div>

                            <!-- Bouton de déconnexion -->
                            <button onclick="logout()" 
                                    class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 transition-colors"
                                    title="Se déconnecter">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Sidebar gauche - Utilisateurs -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sticky top-24">
                            <!-- Statistiques rapides -->
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600" id="active-users-count">0</div>
                                    <div class="text-xs text-gray-500">Connectés</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="daily-messages">0</div>
                                    <div class="text-xs text-gray-500">Messages</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="shared-files">0</div>
                                    <div class="text-xs text-gray-500">Fichiers</div>
                                </div>
                            </div>

                            <!-- Liste des utilisateurs en ligne -->
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        En ligne
                                    </h3>
                                    <div id="online-users" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- Les utilisateurs en ligne seront affichés ici -->
                                    </div>
                                </div>

                                <!-- Section utilisateurs hors ligne (cachée par défaut) -->
                                <div id="offline-users-section" class="hidden">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                        Hors ligne
                                    </h3>
                                    <div id="offline-users" class="space-y-2 max-h-32 overflow-y-auto">
                                        <!-- Les utilisateurs hors ligne seront affichés ici -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zone principale de chat -->
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <!-- Onglets de navigation -->
                            <div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1">
                                <button onclick="switchView('public')" 
                                        class="view-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-900 bg-white shadow-sm border border-blue-500">
                                    <i class="fas fa-users mr-2"></i>Chat Public
                                </button>
                                <button onclick="switchView('private')" 
                                        class="view-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 border border-transparent">
                                    <i class="fas fa-comment-dots mr-2"></i>Messages Privés
                                </button>
                            </div>

                            <!-- Public Chat -->
                            <div id="public-chat" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-lg font-semibold text-gray-900">Discussion Publique</h2>
                                    <button id="admin-clear-chat" onclick="adminClearAllMessages()" 
                                            class="bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 text-sm hidden" 
                                            title="Vider tous les messages (Admin uniquement)">
                                        <i class="fas fa-trash mr-1"></i>Vider le chat
                                    </button>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4 h-80 overflow-y-auto border border-gray-200" id="chat-messages">
                                    <!-- Les messages du chat public seront affichés ici -->
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-comments text-4xl mb-4 opacity-50"></i>
                                        <p>Aucun message pour le moment. Commencez la conversation !</p>
                                    </div>
                                </div>
                                
                                <!-- Zone de fichiers joints -->
                                <div id="attachments-preview" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-blue-700">Fichiers attachés :</span>
                                        <button onclick="clearAttachments()" class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-times"></i> Tout supprimer
                                        </button>
                                    </div>
                                    <div id="attachments-list" class="space-y-2">
                                        <!-- Liste des fichiers attachés -->
                                    </div>
                                </div>
                            </div>

                            <!-- Private Chat -->
                            <div id="private-chat" class="hidden space-y-6">
                                <!-- Sélecteur d'utilisateur -->
                                <div id="private-user-selector" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <i class="fas fa-user-friends text-blue-600"></i>
                                            <span class="text-sm font-medium text-blue-900">Conversation privée avec :</span>
                                        </div>
                                        <select id="private-user-select" onchange="selectPrivateUser(this.value)" class="bg-white border border-blue-300 rounded-lg px-3 py-1 text-sm">
                                            <option value="">Choisissez un utilisateur...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Zone de chat privé (copie exacte du public) -->
                                <div class="flex justify-between items-center">
                                    <h2 class="text-lg font-semibold text-gray-900">Discussion Privée</h2>
                                    <div id="private-chat-info" class="text-sm text-gray-500 hidden">
                                        Conversation avec <span id="selected-user-name"></span>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4 h-80 overflow-y-auto border border-gray-200" id="private-chat-messages">
                                    <!-- Les messages du chat privé seront affichés ici -->
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-user-friends text-4xl mb-4 opacity-50"></i>
                                        <p>Sélectionnez un utilisateur pour commencer une conversation privée</p>
                                    </div>
                                </div>
                                
                                <!-- Zone de fichiers joints (copie exacte du public) -->
                                <div id="private-attachments-preview" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-blue-700">Fichiers attachés :</span>
                                        <button onclick="clearPrivateAttachments()" class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-times"></i> Tout supprimer
                                        </button>
                                    </div>
                                    <div id="private-attachments-list" class="space-y-2">
                                        <!-- Liste des fichiers attachés -->
                                    </div>
                                </div>
                            </div>

                            <!-- Message Input Area -->
                            <div class="border-t border-gray-200 pt-4">
                                <div id="message-input-info" class="mb-2 text-sm text-gray-600 hidden">
                                    <!-- Info sur la conversation privée -->
                                </div>
                                <div class="flex space-x-4 items-end">
                                    <div class="flex-1">
                                        <textarea id="message-input" placeholder="Tapez votre message..." 
                                                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                  rows="3" onkeypress="handleKeyPress(event)"></textarea>
                                    </div>
                                    <div class="flex flex-col space-y-2">
                                        <button onclick="sendMessage()" 
                                                class="gradient-bg text-white p-3 rounded-lg hover-scale" title="Envoyer le message">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <label for="file-input" class="bg-gray-200 text-gray-600 p-3 rounded-lg hover:bg-gray-300 cursor-pointer" title="Joindre un fichier">
                                            <i id="file-icon" class="fas fa-paperclip text-lg"></i>
                                        </label>
                                        <input type="file" id="file-input" class="hidden" multiple onchange="handleFileSelect(event)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                    <img src="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg" alt="H7 Logo" class="w-10 h-10 rounded-full object-cover">
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Rejoindre H7 Social</h2>
                <p class="text-gray-600">Connectez-vous ou créez un compte pour commencer à discuter</p>
            </div>

            <div id="auth-tabs" class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button onclick="switchAuthTab('login')" 
                        class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm">
                    Connexion
                </button>
                <button onclick="switchAuthTab('register')" 
                        class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700">
                    Inscription
                </button>
            </div>

            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                        <input type="text" id="auth-username" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Votre nom d'utilisateur">
                    </div>
                    
                    <div id="password-field" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" id="auth-password"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Votre mot de passe">
                    </div>
                    
                    <div id="avatar-selection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo de profil (optionnelle)</label>
                        <div class="flex justify-center mb-4">
                            <div class="avatar-upload-container">
                                <img id="preview-avatar" src="https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg" alt="Aperçu" 
                                     class="w-20 h-20 rounded-full object-cover border-4 border-gray-200 bg-gray-100">
                                <button type="button" onclick="openRegistrationAvatarUpload()" class="avatar-upload-button" title="Choisir une photo">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                        </div>
                        <input type="file" id="registration-avatar-upload" class="hidden" accept="image/*" onchange="handleRegistrationAvatarUpload(event)">
                    </div>

                    <button type="submit" id="auth-submit"
                            class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover-scale">
                        Se connecter
                    </button>
                </div>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Ou connectez-vous avec</span>
                    </div>
                </div>
                
                <button onclick="loginWithGoogle()" disabled
                        class="mt-4 w-full border border-gray-300 bg-white text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 flex items-center justify-center space-x-2 opacity-50 cursor-not-allowed">
                    <i class="fab fa-google text-red-500"></i>
                    <span>Google (Configurez Firebase d'abord)</span>
                </button>
            </div>

            <button onclick="closeAuthModal()" 
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- General Modal -->
    <div id="general-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="text-gray-700"></div>
        </div>
    </div>

    <script type="module">
        // Configuration Firebase (cachée par défaut pour la sécurité)
        let firebaseConfig = null;
        let firebaseApp = null;
        let database = null;
        let auth = null;

        // Variables globales
        let currentUser = null;
        let messages = [];
        let allUsers = [];
        let currentView = 'public';
        let attachments = [];
        let isLogin = true;
        let privateMessages = []; // Messages privés pour la conversation sélectionnée
        let selectedPrivateUser = null; // Utilisateur sélectionné pour les messages privés
        let privateAttachments = []; // Fichiers joints pour messages privés

        // État de l'application
        let isFirebaseConnected = false;
        let connectionAttempts = 0;
        const MAX_CONNECTION_ATTEMPTS = 3;

        // Initialisation de l'application
        window.addEventListener('DOMContentLoaded', function() {
            loadFirebaseConfig();
            initializeApp();
        });

        // Gestion de la configuration Firebase
        window.toggleConfigPanel = function() {
            const panel = document.getElementById('config-panel');
            panel.classList.toggle('hidden');
        };

        window.saveFirebaseConfig = function() {
            const apiKey = document.getElementById('firebase-api-key').value.trim();
            const dbUrl = document.getElementById('firebase-db-url').value.trim();
            const projectId = document.getElementById('firebase-project-id').value.trim();

            if (!apiKey || !dbUrl || !projectId) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }

            const config = {
                apiKey: apiKey,
                authDomain: projectId + '.firebaseapp.com',
                databaseURL: dbUrl,
                projectId: projectId,
                storageBucket: projectId + '.appspot.com',
                messagingSenderId: '767585260701',
                appId: '1:767585260701:web:9159e8293d385415f87074'
            };

            // Sauvegarder dans localStorage
            localStorage.setItem('h7_firebase_config', JSON.stringify(config));
            firebaseConfig = config;

            // Initialiser Firebase
            initializeFirebase();
            toggleConfigPanel();
        };

        function loadFirebaseConfig() {
            const saved = localStorage.getItem('h7_firebase_config');
            if (saved) {
                try {
                    firebaseConfig = JSON.parse(saved);
                    document.getElementById('firebase-api-key').value = firebaseConfig.apiKey || '';
                    document.getElementById('firebase-db-url').value = firebaseConfig.databaseURL || '';
                    document.getElementById('firebase-project-id').value = firebaseConfig.projectId || '';
                } catch (e) {
                    console.error('Erreur lors du chargement de la configuration:', e);
                }
            }
        }

        function initializeApp() {
            showToast('H7 Social démarre...', 'info');
            
            // Mettre à jour l'état du serveur
            updateServerStatus('connecting');
            
            if (firebaseConfig) {
                initializeFirebase();
            } else {
                updateServerStatus('error');
                showToast('Configuration Firebase requise', 'error');
            }

            // MODIFICATION 2: Supprimer les utilisateurs de démonstration
            // Les utilisateurs seront maintenant chargés uniquement depuis Firebase
            allUsers = [];
            updateUsersList();
        }

        async function initializeFirebase() {
            if (!firebaseConfig) {
                showToast('Configuration Firebase manquante', 'error');
                return;
            }

            try {
                updateServerStatus('connecting');
                
                // Charger Firebase de façon dynamique
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js');
                const { getDatabase, ref, set, push, onValue, off } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js');
                const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');

                // Sauvegarder les références pour usage global
                window.firebaseRefs = { ref, set, push, onValue, off };

                firebaseApp = initializeApp(firebaseConfig);
                database = getDatabase(firebaseApp);
                auth = getAuth(firebaseApp);

                isFirebaseConnected = true;
                updateServerStatus('connected');
                showToast('Firebase connecté avec succès!', 'success');

                // MODIFICATION 1: Corriger l'erreur sur la liste des utilisateurs connectés
                // Écouter les utilisateurs connectés en temps réel
                const usersRef = window.firebaseRefs.ref(database, 'users');
                window.firebaseRefs.onValue(usersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allUsers = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                    } else {
                        allUsers = [];
                    }
                    updateUsersList();
                });

                // Activer le bouton Google
                const googleBtn = document.querySelector('button[onclick="loginWithGoogle()"]');
                if (googleBtn) {
                    googleBtn.disabled = false;
                    googleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    googleBtn.querySelector('span').textContent = 'Continuer avec Google';
                }

            } catch (error) {
                console.error('Erreur Firebase:', error);
                isFirebaseConnected = false;
                updateServerStatus('error');
                
                connectionAttempts++;
                if (connectionAttempts < MAX_CONNECTION_ATTEMPTS) {
                    showToast(`Tentative de reconnexion ${connectionAttempts}/${MAX_CONNECTION_ATTEMPTS}...`, 'error');
                    setTimeout(() => initializeFirebase(), 3000);
                } else {
                    showToast('Impossible de se connecter à Firebase. Vérifiez votre configuration.', 'error');
                }
            }
        }

        function updateServerStatus(status) {
            const indicator = document.getElementById('server-status');
            const text = document.getElementById('server-status-text');
            const connectionIndicator = document.getElementById('connection-status');
            
            switch (status) {
                case 'connected':
                    indicator.className = 'hidden sm:flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                    indicator.querySelector('.w-2').className = 'w-2 h-2 rounded-full bg-green-500';
                    text.textContent = 'Connecté';
                    text.className = 'text-xs text-green-600';
                    connectionIndicator.className = 'w-2 h-2 bg-green-500 rounded-full';
                    break;
                case 'connecting':
                    indicator.className = 'hidden sm:flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
                    indicator.querySelector('.w-2').className = 'w-2 h-2 rounded-full bg-yellow-500';
                    text.textContent = 'Connexion...';
                    text.className = 'text-xs text-yellow-600';
                    connectionIndicator.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                    break;
                case 'error':
                    indicator.className = 'hidden sm:flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                    indicator.querySelector('.w-2').className = 'w-2 h-2 rounded-full bg-red-500';
                    text.textContent = 'Déconnecté';
                    text.className = 'text-xs text-red-600';
                    connectionIndicator.className = 'w-2 h-2 bg-red-500 rounded-full';
                    break;
            }
        }

        // Gestion des modales d'authentification
        window.showAuthModal = function() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('landing-page').classList.add('blur-sm');
        };

        window.closeAuthModal = function() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('landing-page').classList.remove('blur-sm');
        };

        window.switchAuthTab = function(type) {
            const tabs = document.querySelectorAll('.auth-tab');
            const passwordField = document.getElementById('password-field');
            const avatarSelection = document.getElementById('avatar-selection');
            const submitBtn = document.getElementById('auth-submit');
            
            isLogin = type === 'login';
            
            // Mettre à jour les onglets
            tabs.forEach(tab => {
                tab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                tab.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            if (isLogin) {
                tabs[0].classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                tabs[0].classList.remove('text-gray-500', 'hover:text-gray-700');
                passwordField.classList.add('hidden');
                avatarSelection.classList.add('hidden');
                submitBtn.textContent = 'Se connecter';
            } else {
                tabs[1].classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                tabs[1].classList.remove('text-gray-500', 'hover:text-gray-700');
                passwordField.classList.remove('hidden');
                avatarSelection.classList.remove('hidden');
                submitBtn.textContent = 'Créer un compte';
                // MODIFICATION 3: Mettre l'avatar H7 par défaut
                document.getElementById('preview-avatar').src = 'https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg';
            }
        };

        // Gestion de l'authentification
        window.handleAuth = function(event) {
            event.preventDefault();
            
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            
            if (!username) {
                showToast('Veuillez entrer un nom d\'utilisateur', 'error');
                return;
            }
            
            if (!isLogin && !password) {
                showToast('Veuillez entrer un mot de passe', 'error');
                return;
            }

            // MODIFICATION 3: Utiliser l'avatar H7 par défaut
            const avatarUrl = document.getElementById('preview-avatar').src || 'https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg';
            
            currentUser = {
                id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                username: username,
                isAdmin: username.toLowerCase() === 'h7',
                profileImage: avatarUrl,
                isOnline: true
            };

            // Sauvegarder dans localStorage
            localStorage.setItem('h7_current_user', JSON.stringify(currentUser));

            showChatApp();
            closeAuthModal();
            
            showToast(`Bienvenue ${currentUser.username}!`, 'success');
        };

        function showChatApp() {
            // Mettre à jour l'interface utilisateur
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-avatar').src = currentUser.profileImage;
            
            // Afficher les boutons admin si nécessaire
            if (currentUser.isAdmin && currentUser.username === 'H7') {
                document.getElementById('admin-clear-chat').classList.remove('hidden');
            }

            // Masquer la page d'accueil et afficher le chat
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-app').classList.remove('hidden');
            
            if (isFirebaseConnected) {
                initializeFirebaseChat();
            }
        }

        function initializeFirebaseChat() {
            if (!database || !currentUser) return;

            const messagesRef = window.firebaseRefs.ref(database, 'messages');
            
            // Écouter les nouveaux messages publics
            window.firebaseRefs.onValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    messages = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                } else {
                    messages = [];
                }
                updateMessages();
            });

            // Écouter les messages privés pour cet utilisateur
            initializePrivateMessagesListener();

            // Marquer l'utilisateur comme en ligne
            const currentUserRef = window.firebaseRefs.ref(database, `users/${currentUser.id}`);
            window.firebaseRefs.set(currentUserRef, {
                username: currentUser.username,
                isOnline: true,
                isAdmin: currentUser.isAdmin,
                profileImage: currentUser.profileImage,
                lastSeen: new Date().toISOString()
            });

            // Gérer la déconnexion
            window.addEventListener('beforeunload', () => {
                if (database && currentUser) {
                    window.firebaseRefs.set(currentUserRef, {
                        username: currentUser.username,
                        isOnline: false,
                        isAdmin: currentUser.isAdmin,
                        profileImage: currentUser.profileImage,
                        lastSeen: new Date().toISOString()
                    });
                }
            });
        }

        // Fonction pour initialiser l'écoute des messages privés
        function initializePrivateMessagesListener() {
            if (!database || !currentUser) return;

            // Écouter tous les messages privés impliquant cet utilisateur
            const privateMessagesRef = window.firebaseRefs.ref(database, 'privateMessages');
            window.firebaseRefs.onValue(privateMessagesRef, (snapshot) => {
                const data = snapshot.val();
                
                if (data && selectedPrivateUser) {
                    // Créer un ID de conversation cohérent
                    const conversationId = currentUser.id < selectedPrivateUser.id ? 
                        `${currentUser.id}_${selectedPrivateUser.id}` : 
                        `${selectedPrivateUser.id}_${currentUser.id}`;
                    
                    const conversationData = data[conversationId];
                    if (conversationData) {
                        privateMessages = Object.keys(conversationData).map(key => ({
                            id: key,
                            ...conversationData[key]
                        })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    } else {
                        privateMessages = [];
                    }
                    
                    updatePrivateMessages();
                }
            });
        }

        // Fonction pour mettre à jour l'affichage des messages privés (copie exacte du public)
        function updatePrivateMessages() {
            const container = document.getElementById('private-chat-messages');
            
            if (privateMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-comment text-4xl mb-4 opacity-50"></i>
                        <p>Aucun message pour le moment. Commencez la conversation !</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = privateMessages.map(msg => {
                const messageTime = new Date(msg.timestamp);
                const timeString = messageTime.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const attachmentsHtml = msg.attachments ? 
                    msg.attachments.map(att => `
                        <div class="mt-2 p-2 bg-blue-50 rounded border border-blue-200 text-sm flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-paperclip mr-2"></i>
                                <span class="text-blue-700">${att.name}</span>
                                <span class="text-gray-500 ml-2">(${formatFileSize(att.size)})</span>
                            </div>
                            <button onclick="downloadAttachment('${att.url}', '${att.name}')" 
                                    class="text-blue-600 hover:text-blue-800 ml-2" title="Télécharger">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `).join('') : '';

                const isOwner = currentUser && msg.userId === currentUser.id;
                const canEdit = isOwner;
                const canDelete = currentUser && currentUser.isAdmin && currentUser.username === 'H7';

                const actionsHtml = (canEdit || canDelete) ? `
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2 ml-2">
                        ${canEdit ? `<button onclick="editPrivateMessage('${msg.id}')" class="text-gray-400 hover:text-blue-500" title="Éditer">
                            <i class="fas fa-edit text-sm"></i>
                        </button>` : ''}
                        ${canDelete ? `<button onclick="deletePrivateMessage('${msg.id}')" class="text-red-500 hover:text-red-700" title="Supprimer (Admin uniquement)">
                            <i class="fas fa-trash text-sm"></i>
                        </button>` : ''}
                    </div>
                ` : '';

                return `
                    <div class="chat-message group flex space-x-3 mb-4 hover:bg-gray-50 p-2 rounded-lg transition-colors">
                        <img src="${msg.profileImage || getDefaultAvatar(msg.username)}" 
                             alt="${msg.username}" 
                             class="w-10 h-10 rounded-full object-cover ${msg.isAdmin ? 'border-2 border-yellow-400' : ''}"
                             onerror="this.src='${getDefaultAvatar(msg.username)}'">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-medium text-gray-900">${msg.username}</span>
                                ${msg.isAdmin ? '<i class="fas fa-crown text-yellow-500 text-sm" title="Administrateur"></i>' : ''}
                                <span class="text-xs text-gray-500">${timeString}</span>
                                ${actionsHtml}
                            </div>
                            <div class="text-gray-700 break-words" id="private-message-content-${msg.id}">${msg.text}</div>
                            ${attachmentsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Gestion des messages
        window.handleKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (currentView === 'public') {
                    sendMessage();
                } else if (currentView === 'private' && selectedPrivateUser) {
                    sendPrivateMessage(selectedPrivateUser.id);
                }
            }
        };

        window.handlePrivateKeyPress = function(event, userId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendPrivateMessage(userId);
            }
        };

        window.sendPrivateMessage = function(userId) {
            const messageInput = document.getElementById(`private-message-input-${userId}`);
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            if (!currentUser) {
                showToast('Vous devez être connecté pour envoyer un message', 'error');
                return;
            }

            const targetUser = allUsers.find(u => u.id === userId);
            if (!targetUser) {
                showToast('Utilisateur introuvable', 'error');
                return;
            }

            const message = {
                text: messageText,
                from: currentUser.username,
                fromId: currentUser.id,
                to: targetUser.username,
                toId: userId,
                timestamp: new Date().toISOString(),
                isPrivate: true,
                profileImage: currentUser.profileImage
            };

            // Créer un ID de conversation cohérent (toujours le même ordre)
            const conversationId = currentUser.id < userId ? 
                `${currentUser.id}_${userId}` : 
                `${userId}_${currentUser.id}`;

            // Envoyer le message via Firebase
            if (isFirebaseConnected && database) {
                const privateMessagesRef = window.firebaseRefs.ref(database, `privateMessages/${conversationId}`);
                window.firebaseRefs.push(privateMessagesRef, message);
                showToast(`Message envoyé à ${targetUser.username}`, 'success');
            } else {
                showToast('Firebase non connecté', 'error');
            }

            messageInput.value = '';
        };

        window.sendMessage = function() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();

            if (currentView === 'public') {
                // Envoyer message public
                if (!messageText && attachments.length === 0) return;
                if (!currentUser) {
                    showToast('Vous devez être connecté pour envoyer un message', 'error');
                    return;
                }

                const message = {
                    id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    text: messageText,
                    username: currentUser.username,
                    userId: currentUser.id,
                    timestamp: new Date().toISOString(),
                    isAdmin: currentUser.isAdmin,
                    profileImage: currentUser.profileImage,
                    attachments: attachments.length > 0 ? [...attachments] : null
                };

                if (isFirebaseConnected && database) {
                    const messagesRef = window.firebaseRefs.ref(database, 'messages');
                    window.firebaseRefs.push(messagesRef, message);
                } else {
                    messages.push(message);
                    updateMessages();
                }

                messageInput.value = '';
                clearAttachments();
                messageInput.focus();

            } else if (currentView === 'private') {
                // Envoyer message privé
                if (!messageText && privateAttachments.length === 0) return;
                if (!currentUser) {
                    showToast('Vous devez être connecté pour envoyer un message', 'error');
                    return;
                }
                if (!selectedPrivateUser) {
                    showToast('Sélectionnez un utilisateur pour envoyer un message privé', 'error');
                    return;
                }

                const message = {
                    text: messageText,
                    username: currentUser.username,
                    userId: currentUser.id,
                    timestamp: new Date().toISOString(),
                    isAdmin: currentUser.isAdmin,
                    profileImage: currentUser.profileImage,
                    attachments: privateAttachments.length > 0 ? [...privateAttachments] : null
                };

                // Créer un ID de conversation cohérent
                const conversationId = currentUser.id < selectedPrivateUser.id ? 
                    `${currentUser.id}_${selectedPrivateUser.id}` : 
                    `${selectedPrivateUser.id}_${currentUser.id}`;

                if (isFirebaseConnected && database) {
                    const privateMessagesRef = window.firebaseRefs.ref(database, `privateMessages/${conversationId}`);
                    window.firebaseRefs.push(privateMessagesRef, message);
                } else {
                    privateMessages.push(message);
                    updatePrivateMessages();
                }

                messageInput.value = '';
                clearPrivateAttachments();
                messageInput.focus();
            }
        };

        function updateMessages() {
            const container = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-comments text-4xl mb-4 opacity-50"></i>
                        <p>Aucun message pour le moment. Commencez la conversation !</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const messageTime = new Date(msg.timestamp);
                const timeString = messageTime.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const attachmentsHtml = msg.attachments ? 
                    msg.attachments.map(att => `
                        <div class="mt-2 p-2 bg-blue-50 rounded border border-blue-200 text-sm flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-paperclip mr-2"></i>
                                <span class="text-blue-700">${att.name}</span>
                                <span class="text-gray-500 ml-2">(${formatFileSize(att.size)})</span>
                            </div>
                            <button onclick="downloadAttachment('${att.url}', '${att.name}')" 
                                    class="text-blue-600 hover:text-blue-800 ml-2" title="Télécharger">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `).join('') : '';

                const isOwner = currentUser && msg.userId === currentUser.id;
                const canEdit = isOwner;
                const canDelete = currentUser && currentUser.isAdmin && currentUser.username === 'H7';

                const actionsHtml = (canEdit || canDelete) ? `
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2 ml-2">
                        ${canEdit ? `<button onclick="editMessage('${msg.id}')" class="text-gray-400 hover:text-blue-500" title="Éditer">
                            <i class="fas fa-edit text-sm"></i>
                        </button>` : ''}
                        ${canDelete ? `<button onclick="deleteMessage('${msg.id}')" class="text-red-500 hover:text-red-700" title="Supprimer (Admin uniquement)">
                            <i class="fas fa-trash text-sm"></i>
                        </button>` : ''}
                    </div>
                ` : '';

                return `
                    <div class="chat-message group flex space-x-3 mb-4 hover:bg-gray-50 p-2 rounded-lg transition-colors">
                        <img src="${msg.profileImage || getDefaultAvatar(msg.username)}" 
                             alt="${msg.username}" 
                             class="w-10 h-10 rounded-full object-cover ${msg.isAdmin ? 'border-2 border-yellow-400' : ''}"
                             onerror="this.src='${getDefaultAvatar(msg.username)}'">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-medium text-gray-900">${msg.username}</span>
                                ${msg.isAdmin ? '<i class="fas fa-crown text-yellow-500 text-sm" title="Administrateur"></i>' : ''}
                                <span class="text-xs text-gray-500">${timeString}</span>
                                ${actionsHtml}
                            </div>
                            <div class="text-gray-700 break-words" id="message-content-${msg.id}">${msg.text}</div>
                            ${attachmentsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Sélection d'utilisateur privé
        window.selectPrivateUser = function(userId) {
            if (!userId) {
                selectedPrivateUser = null;
                privateMessages = [];
                updatePrivateMessages();
                document.getElementById('private-chat-info').classList.add('hidden');
                return;
            }

            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            selectedPrivateUser = user;
            privateMessages = [];
            
            // Mettre à jour l'interface
            document.getElementById('selected-user-name').textContent = user.username;
            document.getElementById('private-chat-info').classList.remove('hidden');
            
            // Recharger l'écoute pour cette conversation
            initializePrivateMessagesListener();
            
            showToast(`Conversation privée avec ${user.username}`, 'info');
        };

        // Gestion des utilisateurs
        function updateUsersList() {
            const onlineContainer = document.getElementById('online-users');
            const offlineContainer = document.getElementById('offline-users');
            const offlineSection = document.getElementById('offline-users-section');
            const activeCount = document.getElementById('active-users-count');
            const privateUserSelect = document.getElementById('private-user-select');

            const onlineUsers = allUsers.filter(u => u.isOnline);
            const offlineUsers = allUsers.filter(u => !u.isOnline);

            // Mettre à jour les utilisateurs en ligne
            if (onlineUsers.length > 0) {
                onlineContainer.innerHTML = onlineUsers.map(user => {
                    const avatarUrl = user.profileImage || 'https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg';
                    const isAdminH7 = currentUser && currentUser.isAdmin && currentUser.username === 'H7';
                    const disconnectButton = isAdminH7 && user.id !== currentUser.id ? 
                        `<button onclick="forceDisconnectUser('${user.id}')" 
                                 class="admin-disconnect-btn" 
                                 title="Déconnecter cet utilisateur (Admin H7 uniquement)">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>` : '';
                    
                    return `
                        <div onclick="selectUser('${user.id}')" 
                             class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center space-x-3">
                                <img src="${avatarUrl}" alt="Profil ${user.username}" 
                                     class="w-10 h-10 rounded-full object-cover ${user.isAdmin ? 'border-2 border-yellow-400' : ''}"
                                     onerror="this.src='https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg'">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">
                                        ${user.username} ${user.isAdmin ? '(Admin) 👑' : ''}
                                    </p>
                                    <div class="flex items-center space-x-1">
                                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                        <span class="text-xs text-green-600">En ligne</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${user.isAdmin ? '<i class="fas fa-crown text-yellow-500"></i>' : ''}
                                ${disconnectButton}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Message différent selon l'état de Firebase
                if (!isFirebaseConnected) {
                    onlineContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-6">
                            <i class="fas fa-cog text-3xl mb-3 opacity-50"></i>
                            <p class="text-sm font-medium mb-2">Firebase non configuré</p>
                            <p class="text-xs">Cliquez sur l'icône paramètres pour configurer</p>
                            <button onclick="toggleConfigPanel()" class="mt-3 px-4 py-2 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600">
                                Configurer maintenant
                            </button>
                        </div>
                    `;
                } else {
                    onlineContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-user-friends text-2xl mb-2 opacity-50"></i>
                            <p class="text-sm">Aucun utilisateur connecté</p>
                            <p class="text-xs mt-1">Les utilisateurs apparaîtront ici une fois connectés</p>
                        </div>
                    `;
                }
            }

            // Cacher complètement la section des utilisateurs hors ligne
            offlineSection.classList.add('hidden');

            // Mettre à jour le sélecteur d'utilisateurs privés
            if (privateUserSelect) {
                privateUserSelect.innerHTML = '<option value="">Choisissez un utilisateur...</option>' +
                    onlineUsers.filter(u => u.id !== (currentUser ? currentUser.id : '')).map(user => `
                        <option value="${user.id}">${user.username} ${user.isAdmin ? '👑' : ''}</option>
                    `).join('');
            }

            // Mettre à jour les statistiques
            activeCount.textContent = onlineUsers.length;
            document.getElementById('daily-messages').textContent = messages.length;
            document.getElementById('shared-files').textContent = messages.filter(m => m.attachments && m.attachments.length > 0).length;
        }

        // Fonction pour déconnecter un utilisateur (Admin H7 uniquement)
        window.forceDisconnectUser = function(userId) {
            if (!currentUser || !currentUser.isAdmin || currentUser.username !== 'H7') {
                showToast('Action non autorisée', 'error');
                return;
            }

            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showToast('Utilisateur introuvable', 'error');
                return;
            }

            if (confirm(`Êtes-vous sûr de vouloir déconnecter ${user.username} ?`)) {
                // Marquer l'utilisateur comme hors ligne dans Firebase
                if (isFirebaseConnected && database) {
                    const userRef = window.firebaseRefs.ref(database, `users/${userId}`);
                    window.firebaseRefs.set(userRef, {
                        username: user.username,
                        isOnline: false,
                        isAdmin: user.isAdmin,
                        profileImage: user.profileImage,
                        lastSeen: new Date().toISOString(),
                        forcedDisconnect: true
                    });
                }
                
                showToast(`${user.username} a été déconnecté`, 'success');
            }
        };

        // Avatar et profil utilisateur
        window.openAvatarUpload = function() {
            document.getElementById('avatar-upload').click();
        };

        window.openRegistrationAvatarUpload = function() {
            document.getElementById('registration-avatar-upload').click();
        };

        window.handleAvatarUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarUrl = e.target.result;
                    document.getElementById('user-avatar').src = avatarUrl;
                    
                    if (currentUser) {
                        currentUser.profileImage = avatarUrl;
                        localStorage.setItem('h7_current_user', JSON.stringify(currentUser));
                        
                        // Mettre à jour dans Firebase
                        if (isFirebaseConnected && database) {
                            const userRef = window.firebaseRefs.ref(database, `users/${currentUser.id}`);
                            window.firebaseRefs.set(userRef, {
                                username: currentUser.username,
                                isOnline: true,
                                isAdmin: currentUser.isAdmin,
                                profileImage: avatarUrl,
                                lastSeen: new Date().toISOString()
                            });
                        }
                        
                        showToast('Avatar mis à jour', 'success');
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleRegistrationAvatarUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-avatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // Gestion des fichiers joints
        window.handleFileSelect = function(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showToast(`Le fichier ${file.name} est trop volumineux (max 10MB)`, 'error');
                    return;
                }
                
                const attachment = {
                    id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file)
                };
                
                // Ajouter à la bonne liste selon la vue actuelle
                if (currentView === 'public') {
                    attachments.push(attachment);
                    updateAttachmentsPreview();
                } else {
                    privateAttachments.push(attachment);
                    updatePrivateAttachmentsPreview();
                }
            });
            
            event.target.value = ''; // Reset input
        };

        function updateAttachmentsPreview() {
            const preview = document.getElementById('attachments-preview');
            const list = document.getElementById('attachments-list');
            
            if (attachments.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            preview.classList.remove('hidden');
            list.innerHTML = attachments.map(att => `
                <div class="flex items-center justify-between p-2 bg-white rounded border">
                    <div class="flex items-center">
                        <i class="fas fa-paperclip mr-2 text-blue-500"></i>
                        <span class="text-sm text-gray-900">${att.name}</span>
                        <span class="text-xs text-gray-500 ml-2">(${formatFileSize(att.size)})</span>
                    </div>
                    <button onclick="removeAttachment('${att.id}')" class="text-red-500 hover:text-red-700" title="Supprimer">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        window.removeAttachment = function(attachmentId) {
            attachments = attachments.filter(att => att.id !== attachmentId);
            updateAttachmentsPreview();
        };

        window.clearAttachments = function() {
            attachments = [];
            updateAttachmentsPreview();
        };

        // Fonctions pour les pièces jointes privées
        window.clearPrivateAttachments = function() {
            privateAttachments = [];
            updatePrivateAttachmentsPreview();
        };

        function updatePrivateAttachmentsPreview() {
            const preview = document.getElementById('private-attachments-preview');
            const list = document.getElementById('private-attachments-list');
            
            if (privateAttachments.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            preview.classList.remove('hidden');
            list.innerHTML = privateAttachments.map(att => `
                <div class="flex items-center justify-between p-2 bg-white rounded border">
                    <div class="flex items-center">
                        <i class="fas fa-paperclip mr-2 text-blue-500"></i>
                        <span class="text-sm text-gray-900">${att.name}</span>
                        <span class="text-xs text-gray-500 ml-2">(${formatFileSize(att.size)})</span>
                    </div>
                    <button onclick="removePrivateAttachment('${att.id}')" class="text-red-500 hover:text-red-700" title="Supprimer">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        window.removePrivateAttachment = function(attachmentId) {
            privateAttachments = privateAttachments.filter(att => att.id !== attachmentId);
            updatePrivateAttachmentsPreview();
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Navigation entre les vues
        window.switchView = function(view) {
            const tabs = document.querySelectorAll('.view-tab');
            const publicChat = document.getElementById('public-chat');
            const privateChat = document.getElementById('private-chat');
            const messageInput = document.getElementById('message-input');
            const inputInfo = document.getElementById('message-input-info');
            
            // Mettre à jour les onglets
            tabs.forEach(tab => {
                tab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm', 'border-blue-500');
                tab.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
            });
            
            if (view === 'public') {
                tabs[0].classList.add('bg-white', 'text-gray-900', 'shadow-sm', 'border-blue-500');
                tabs[0].classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                publicChat.classList.remove('hidden');
                privateChat.classList.add('hidden');
                currentView = 'public';
                
                // Mettre à jour le placeholder et cacher l'info
                messageInput.placeholder = 'Tapez votre message...';
                inputInfo.classList.add('hidden');
                selectedPrivateUser = null;
            } else {
                tabs[1].classList.add('border-blue-500', 'text-blue-600');
                tabs[1].classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                publicChat.classList.add('hidden');
                privateChat.classList.remove('hidden');
                currentView = 'private';
                
                // Mettre à jour le placeholder et l'info
                if (selectedPrivateUser) {
                    messageInput.placeholder = `Message privé à ${selectedPrivateUser.username}...`;
                    inputInfo.innerHTML = `<i class="fas fa-lock mr-1"></i>Conversation privée avec <strong>${selectedPrivateUser.username}</strong>`;
                    inputInfo.classList.remove('hidden');
                } else {
                    messageInput.placeholder = 'Sélectionnez un utilisateur pour commencer...';
                    inputInfo.classList.add('hidden');
                }
            }
        };

        // Gestion de la déconnexion
        window.logout = function() {
            if (currentUser && isFirebaseConnected && database) {
                const userRef = window.firebaseRefs.ref(database, `users/${currentUser.id}`);
                window.firebaseRefs.set(userRef, {
                    username: currentUser.username,
                    isOnline: false,
                    isAdmin: currentUser.isAdmin,
                    profileImage: currentUser.profileImage,
                    lastSeen: new Date().toISOString()
                });
            }

            currentUser = null;
            messages = [];
            attachments = [];
            
            document.getElementById('chat-app').classList.add('hidden');
            document.getElementById('landing-page').classList.remove('hidden');
            
            showToast('Déconnexion réussie', 'success');
        };

        // Authentification Google
        window.loginWithGoogle = function() {
            if (!isFirebaseConnected || !auth) {
                showToast('Firebase n\'est pas configuré', 'error');
                return;
            }
            
            showToast('Connexion Google (à implémenter)', 'info');
        };

        // Gestion des modales
        window.showModal = function(type) {
            const modal = document.getElementById('general-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');

            const modalContent = {
                about: {
                    title: 'À propos de H7 Social',
                    content: `
                        <div class="space-y-4">
                            <p class="text-gray-600">
                                H7 Social est une plateforme de communication moderne développée pour connecter les utilisateurs en temps réel. 
                                Notre mission est de faciliter l'échange, le partage et la collaboration au sein d'une communauté dynamique.
                            </p>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">🎯 Objectifs principaux</h4>
                                <ul class="text-blue-800 space-y-1 text-sm">
                                    <li>• Faciliter la communication en temps réel</li>
                                    <li>• Créer une expérience utilisateur intuitive</li>
                                    <li>• Assurer la sécurité des données</li>
                                    <li>• Favoriser l'échange entre utilisateurs</li>
                                </ul>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-900 mb-2">⚡ Technologies utilisées</h4>
                                <ul class="text-green-800 space-y-1 text-sm">
                                    <li>• Firebase pour la base de données temps réel</li>
                                    <li>• Interface responsive avec Tailwind CSS</li>
                                    <li>• JavaScript moderne (ES6+)</li>
                                    <li>• Système d'authentification sécurisé</li>
                                </ul>
                            </div>
                        </div>
                    `
                },
                features: {
                    title: 'Fonctionnalités de H7 Social',
                    content: `
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
                                        <i class="fas fa-users mr-2"></i>Chat Public
                                    </h4>
                                    <p class="text-blue-800 text-sm">Participez aux discussions de groupe en temps réel avec tous les membres de la communauté.</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-purple-900 mb-2 flex items-center">
                                        <i class="fas fa-comment-dots mr-2"></i>Messages Privés
                                    </h4>
                                    <p class="text-purple-800 text-sm">Échangez en privé avec vos contacts de manière sécurisée et confidentielle.</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-900 mb-2 flex items-center">
                                        <i class="fas fa-paperclip mr-2"></i>Partage de Fichiers
                                    </h4>
                                    <p class="text-green-800 text-sm">Partagez documents, images et autres fichiers facilement avec la communauté.</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-900 mb-2 flex items-center">
                                        <i class="fas fa-crown mr-2"></i>Système Admin
                                    </h4>
                                    <p class="text-yellow-800 text-sm">Outils de modération avancés pour maintenir un environnement sain.</p>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-2">🔮 Fonctionnalités à venir</h4>
                                <ul class="text-gray-700 space-y-1 text-sm">
                                    <li>• Appels vidéo intégrés</li>
                                    <li>• Système de notifications push</li>
                                    <li>• Thèmes personnalisables</li>
                                    <li>• Intégration avec d'autres plateformes</li>
                                </ul>
                            </div>
                        </div>
                    `
                },
                help: {
                    title: 'Centre d\'aide',
                    content: `
                        <div class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">🚀 Premiers pas</h4>
                                <ol class="text-blue-800 space-y-1 text-sm list-decimal list-inside">
                                    <li>Configurez Firebase en cliquant sur l'icône paramètres</li>
                                    <li>Créez votre compte ou connectez-vous</li>
                                    <li>Personnalisez votre profil et avatar</li>
                                    <li>Commencez à discuter dans le chat public</li>
                                </ol>
                            </div>
                            
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-900">❓ Questions fréquentes</h4>
                                
                                <div class="bg-gray-50 p-3 rounded">
                                    <h5 class="font-medium text-gray-800 mb-1">Comment envoyer un message privé ?</h5>
                                    <p class="text-gray-600 text-sm">Cliquez sur un utilisateur dans la liste des connectés, puis basculez sur l'onglet "Messages Privés".</p>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded">
                                    <h5 class="font-medium text-gray-800 mb-1">Comment joindre un fichier ?</h5>
                                    <p class="text-gray-600 text-sm">Utilisez l'icône trombone à côté du bouton d'envoi pour sélectionner vos fichiers.</p>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded">
                                    <h5 class="font-medium text-gray-800 mb-1">Pourquoi Firebase ?</h5>
                                    <p class="text-gray-600 text-sm">Firebase permet la synchronisation en temps réel entre tous les utilisateurs connectés.</p>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-900 mb-2">💡 Conseils d'utilisation</h4>
                                <ul class="text-yellow-800 space-y-1 text-sm">
                                    <li>• Utilisez Entrée pour envoyer rapidement vos messages</li>
                                    <li>• Maintenez un comportement respectueux</li>
                                    <li>• N'hésitez pas à personnaliser votre avatar</li>
                                    <li>• Les administrateurs ont une couronne dorée 👑</li>
                                </ul>
                            </div>
                        </div>
                    `
                },
                blog: {
                    title: 'Blog H7 Social',
                    content: `
                        <div class="space-y-6">
                            <div class="border-b border-gray-200 pb-4">
                                <h4 class="font-semibold text-gray-900 mb-2">📅 Dernières actualités</h4>
                                <p class="text-gray-600 text-sm">Restez informés des dernières mises à jour et nouveautés de la plateforme.</p>
                            </div>
                            
                            <article class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Nouveau</span>
                                    <span class="text-gray-500 text-sm">25 Août 2025</span>
                                </div>
                                <h5 class="font-semibold text-gray-900 mb-2">🎉 Lancement de H7 Social v1.0</h5>
                                <p class="text-gray-600 text-sm mb-3">
                                    Nous sommes fiers de vous présenter la première version stable de H7 Social ! 
                                    Cette version inclut toutes les fonctionnalités de base pour une expérience de chat moderne.
                                </p>
                                <div class="text-sm text-gray-500">
                                    <span class="font-medium">Nouvelles fonctionnalités :</span> Chat temps réel, Messages privés, Partage de fichiers
                                </div>
                            </article>
                            
                            <article class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Mise à jour</span>
                                    <span class="text-gray-500 text-sm">20 Août 2025</span>
                                </div>
                                <h5 class="font-semibold text-gray-900 mb-2">🔧 Améliorations de performance</h5>
                                <p class="text-gray-600 text-sm">
                                    Optimisation des temps de chargement et amélioration de la stabilité de la connexion Firebase.
                                </p>
                            </article>
                            
                            <article class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">Annonce</span>
                                    <span class="text-gray-500 text-sm">15 Août 2025</span>
                                </div>
                                <h5 class="font-semibold text-gray-900 mb-2">🚀 Projet H7 Social officiellement lancé</h5>
                                <p class="text-gray-600 text-sm">
                                    Début du développement de H7 Social avec pour objectif de créer une plateforme de communication moderne et intuitive.
                                </p>
                            </article>
                        </div>
                    `
                },
                privacy: {
                    title: 'Politique de confidentialité',
                    content: `
                        <div class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">🔒 Vos données sont protégées</h4>
                                <p class="text-blue-800 text-sm">
                                    H7 Social s'engage à protéger votre vie privée et vos données personnelles selon les standards les plus élevés.
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">📊 Données collectées</h4>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Nom d'utilisateur choisi lors de l'inscription</li>
                                        <li>Messages envoyés dans les chats publics</li>
                                        <li>Avatar personnalisé (optionnel)</li>
                                        <li>Informations de connexion (horodatage)</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">🎯 Utilisation des données</h4>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Fournir le service de chat en temps réel</li>
                                        <li>Personnaliser votre expérience utilisateur</li>
                                        <li>Assurer la sécurité de la plateforme</li>
                                        <li>Améliorer nos services</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">🛡️ Protection des données</h4>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Chiffrement des données en transit</li>
                                        <li>Stockage sécurisé sur Firebase</li>
                                        <li>Accès limité aux données personnelles</li>
                                        <li>Suppression automatique des données inactives</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                terms: {
                    title: 'Conditions d\'utilisation',
                    content: `
                        <div class="space-y-6">
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-900 mb-2">📋 Règles de la communauté</h4>
                                <p class="text-yellow-800 text-sm">
                                    En utilisant H7 Social, vous acceptez de respecter ces règles pour maintenir un environnement sain et accueillant.
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">✅ Comportements encouragés</h4>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Respecter tous les membres de la communauté</li>
                                        <li>Partager du contenu constructif et pertinent</li>
                                        <li>Aider les nouveaux utilisateurs</li>
                                        <li>Signaler les comportements inappropriés</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">❌ Comportements interdits</h4>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Harcèlement ou intimidation</li>
                                        <li>Contenu offensant, discriminatoire ou haineux</li>
                                        <li>Spam ou publicité non autorisée</li>
                                        <li>Partage d'informations privées sans consentement</li>
                                        <li>Tentatives de piratage ou d'exploitation</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">⚖️ Sanctions</h4>
                                    <p class="text-gray-600 text-sm mb-2">
                                        Le non-respect de ces règles peut entraîner :
                                    </p>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Avertissement</li>
                                        <li>Restriction temporaire</li>
                                        <li>Bannissement définitif</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                cookies: {
                    title: 'Politique des cookies',
                    content: `
                        <div class="space-y-6">
                            <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-orange-900 mb-2">🍪 Utilisation des cookies</h4>
                                <p class="text-orange-800 text-sm">
                                    H7 Social utilise des cookies et des technologies similaires pour améliorer votre expérience utilisateur.
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">🔧 Types de cookies utilisés</h4>
                                    <div class="space-y-3">
                                        <div class="bg-gray-50 p-3 rounded">
                                            <h5 class="font-medium text-gray-800 mb-1">Cookies essentiels</h5>
                                            <p class="text-gray-600 text-sm">Nécessaires au fonctionnement de base de la plateforme (authentification, préférences).</p>
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded">
                                            <h5 class="font-medium text-gray-800 mb-1">Cookies de performance</h5>
                                            <p class="text-gray-600 text-sm">Collectent des informations anonymes sur l'utilisation pour améliorer nos services.</p>
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded">
                                            <h5 class="font-medium text-gray-800 mb-1">Cookies de personnalisation</h5>
                                            <p class="text-gray-600 text-sm">Stockent vos préférences pour personnaliser votre expérience.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">⚙️ Gestion des cookies</h4>
                                    <p class="text-gray-600 text-sm mb-2">
                                        Vous pouvez contrôler l'utilisation des cookies via :
                                    </p>
                                    <ul class="text-gray-600 space-y-1 text-sm list-disc list-inside">
                                        <li>Les paramètres de votre navigateur</li>
                                        <li>Les préférences de votre compte H7 Social</li>
                                        <li>Les outils de gestion des cookies tiers</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                contact: {
                    title: 'Contact',
                    content: `
                        <div class="space-y-6">
                            <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-900 mb-2">📧 Nous contacter</h4>
                                <p class="text-green-800 text-sm">
                                    L'équipe H7 Social est à votre disposition pour toute question, suggestion ou problème technique.
                                </p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-900 mb-2 flex items-center">
                                        <i class="fas fa-life-ring mr-2 text-blue-500"></i>Support technique
                                    </h5>
                                    <p class="text-gray-600 text-sm mb-2">Pour les problèmes techniques et bugs</p>
                                    <a href="mailto:support@h7social.com" class="text-blue-600 hover:text-blue-800 text-sm">
                                        support@h7social.com
                                    </a>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-900 mb-2 flex items-center">
                                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Suggestions
                                    </h5>
                                    <p class="text-gray-600 text-sm mb-2">Pour vos idées d'amélioration</p>
                                    <a href="mailto:ideas@h7social.com" class="text-blue-600 hover:text-blue-800 text-sm">
                                        ideas@h7social.com
                                    </a>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-900 mb-2 flex items-center">
                                        <i class="fas fa-shield-alt mr-2 text-red-500"></i>Signalement
                                    </h5>
                                    <p class="text-gray-600 text-sm mb-2">Pour signaler un contenu inapproprié</p>
                                    <a href="mailto:report@h7social.com" class="text-blue-600 hover:text-blue-800 text-sm">
                                        report@h7social.com
                                    </a>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-semibold text-gray-900 mb-2 flex items-center">
                                        <i class="fas fa-handshake mr-2 text-green-500"></i>Partenariats
                                    </h5>
                                    <p class="text-gray-600 text-sm mb-2">Pour les collaborations</p>
                                    <a href="mailto:partners@h7social.com" class="text-blue-600 hover:text-blue-800 text-sm">
                                        partners@h7social.com
                                    </a>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900 mb-2">⏰ Temps de réponse</h4>
                                <ul class="text-blue-800 space-y-1 text-sm">
                                    <li>• Support technique : sous 24h</li>
                                    <li>• Suggestions : sous 48h</li>
                                    <li>• Signalements : sous 2h</li>
                                    <li>• Partenariats : sous 1 semaine</li>
                                </ul>
                            </div>
                        </div>
                    `
                }
            };

            if (modalContent[type]) {
                title.textContent = modalContent[type].title;
                content.innerHTML = modalContent[type].content;
                modal.classList.remove('hidden');
            }
        };

        window.closeModal = function() {
            document.getElementById('general-modal').classList.add('hidden');
        };

        // Fonction pour télécharger les pièces jointes
        window.downloadAttachment = function(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`Téléchargement de ${filename} démarré`, 'success');
        };

        // Utilitaires
        function getDefaultAvatar(username) {
            // MODIFICATION 3: Retourner toujours l'avatar H7 par défaut
            return 'https://h-7.eu/wp-content/uploads/2023/06/cropped-favicon.jpg';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Fonctions d'administration
        window.adminClearAllMessages = function() {
            if (!currentUser || !currentUser.isAdmin || currentUser.username !== 'H7') {
                showToast('Action non autorisée', 'error');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer tous les messages ? Cette action est irréversible.')) {
                if (isFirebaseConnected && database) {
                    // Supprimer tous les messages dans Firebase
                    const messagesRef = window.firebaseRefs.ref(database, 'messages');
                    window.firebaseRefs.set(messagesRef, null);
                } else {
                    // Mode local
                    messages = [];
                    updateMessages();
                }
                
                showToast('Tous les messages ont été supprimés', 'success');
            }
        };

        window.deleteMessage = function(messageId) {
            if (!currentUser || !currentUser.isAdmin || currentUser.username !== 'H7') {
                showToast('Action non autorisée', 'error');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer ce message ?')) {
                if (isFirebaseConnected && database) {
                    const messageRef = window.firebaseRefs.ref(database, `messages/${messageId}`);
                    window.firebaseRefs.set(messageRef, null);
                } else {
                    messages = messages.filter(msg => msg.id !== messageId);
                    updateMessages();
                }
                
                showToast('Message supprimé', 'success');
            }
        };

        window.editMessage = function(messageId) {
            const message = messages.find(msg => msg.id === messageId);
            if (!message) return;

            if (!currentUser || message.userId !== currentUser.id) {
                showToast('Vous ne pouvez éditer que vos propres messages', 'error');
                return;
            }

            const newText = prompt('Modifier le message:', message.text);
            if (newText !== null && newText.trim() !== '') {
                if (isFirebaseConnected && database) {
                    const messageRef = window.firebaseRefs.ref(database, `messages/${messageId}/text`);
                    window.firebaseRefs.set(messageRef, newText.trim());
                } else {
                    message.text = newText.trim();
                    updateMessages();
                }
                
                showToast('Message modifié', 'success');
            }
        };

        // Fonctions pour les utilisateurs sélectionnés (simplifiée pour utiliser le nouveau système)
        window.selectUser = function(userId) {
            // Passer en mode privé et sélectionner l'utilisateur
            if (currentView !== 'private') {
                switchView('private');
            }
            
            // Mettre à jour le sélecteur
            const privateUserSelect = document.getElementById('private-user-select');
            if (privateUserSelect) {
                privateUserSelect.value = userId;
                selectPrivateUser(userId);
            }
        };

        // Fonctions d'édition et suppression pour messages privés
        window.editPrivateMessage = function(messageId) {
            const message = privateMessages.find(msg => msg.id === messageId);
            if (!message) return;

            if (!currentUser || message.userId !== currentUser.id) {
                showToast('Vous ne pouvez éditer que vos propres messages', 'error');
                return;
            }

            const newText = prompt('Modifier le message:', message.text);
            if (newText !== null && newText.trim() !== '') {
                if (isFirebaseConnected && database && selectedPrivateUser) {
                    const conversationId = currentUser.id < selectedPrivateUser.id ? 
                        `${currentUser.id}_${selectedPrivateUser.id}` : 
                        `${selectedPrivateUser.id}_${currentUser.id}`;
                    const messageRef = window.firebaseRefs.ref(database, `privateMessages/${conversationId}/${messageId}/text`);
                    window.firebaseRefs.set(messageRef, newText.trim());
                } else {
                    message.text = newText.trim();
                    updatePrivateMessages();
                }
                
                showToast('Message privé modifié', 'success');
            }
        };

        window.deletePrivateMessage = function(messageId) {
            if (!currentUser || !currentUser.isAdmin || currentUser.username !== 'H7') {
                showToast('Action non autorisée', 'error');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir supprimer ce message privé ?')) {
                if (isFirebaseConnected && database && selectedPrivateUser) {
                    const conversationId = currentUser.id < selectedPrivateUser.id ? 
                        `${currentUser.id}_${selectedPrivateUser.id}` : 
                        `${selectedPrivateUser.id}_${currentUser.id}`;
                    const messageRef = window.firebaseRefs.ref(database, `privateMessages/${conversationId}/${messageId}`);
                    window.firebaseRefs.set(messageRef, null);
                } else {
                    privateMessages = privateMessages.filter(msg => msg.id !== messageId);
                    updatePrivateMessages();
                }
                
                showToast('Message privé supprimé', 'success');
            }
        };

        // Gestionnaires d'événements pour fermer les modales en cliquant à l'extérieur
        document.addEventListener('click', function(event) {
            const authModal = document.getElementById('auth-modal');
            const generalModal = document.getElementById('general-modal');
            
            if (event.target === authModal) {
                closeAuthModal();
            }
            
            if (event.target === generalModal) {
                closeModal();
            }
        });
    </script>
</body>
</html>