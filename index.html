<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H7 Social - Plateforme de Communication Moderne</title>
    <meta name="description" content="H7 Social est une plateforme de communication moderne qui connecte les utilisateurs en temps réel. Échangez, partagez et collaborez en toute simplicité.">
    
    <!-- Open Graph -->
    <meta property="og:title" content="H7 Social - Communication en Temps Réel">
    <meta property="og:description" content="Rejoignez H7 Social pour discuter avec la communauté en temps réel, envoyer des messages privés et rester connecté avec vos amis.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=630">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary: #3B82F6;
            --secondary: #8B5CF6;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .chat-message {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 60;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 16px;
            max-width: 300px;
            border-left: 4px solid #3B82F6;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            border-left-color: #EF4444;
        }
        
        .toast.success {
            border-left-color: #10B981;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .avatar-upload-container {
            position: relative;
            display: inline-block;
        }
        
        .avatar-upload-button {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .config-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            max-width: 350px;
        }

        .admin-disconnect-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .admin-disconnect-btn:hover {
            background: #dc2626;
        }

        .admin-disconnect-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Configuration Panel -->
    <div id="config-panel" class="config-panel hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Configuration Firebase</h3>
            <button onclick="toggleConfigPanel()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <input type="text" id="firebase-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Votre clé API Firebase">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Database URL</label>
                <input type="text" id="firebase-db-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="URL de votre base de données">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Project ID</label>
                <input type="text" id="firebase-project-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="ID du projet">
            </div>
            <button onclick="saveFirebaseConfig()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">
                Sauvegarder et Connecter
            </button>
            <p class="text-xs text-gray-500">Ces informations sont stockées localement dans votre navigateur</p>
        </div>
    </div>

    <!-- Settings Button -->
    <button onclick="toggleConfigPanel()" 
            class="fixed top-4 left-4 z-50 bg-white p-3 rounded-full shadow-lg border border-gray-200 hover:bg-gray-50 transition-colors">
        <i class="fas fa-cog text-gray-600"></i>
    </button>

    <!-- Application Container -->
    <div id="app" class="min-h-screen">
        <!-- Landing Page -->
        <div id="landing-page" class="min-h-screen bg-gray-50">
            <!-- Hero Section -->
            <div class="relative min-h-screen bg-cover bg-center flex items-center justify-center" 
                 style="background-image: url('https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&h=1080')">
                <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                <div class="relative z-10 text-center text-white max-w-4xl px-6">
                    <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-8">
                        <i class="fas fa-comments text-white text-3xl"></i>
                    </div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-6">H7 Social</h1>
                    <p class="text-xl md:text-2xl mb-8 opacity-90">
                        La plateforme de communication moderne qui connecte les utilisateurs en temps réel
                    </p>
                    <button onclick="showAuthModal()" 
                            class="gradient-bg text-white px-8 py-4 rounded-lg text-lg font-semibold hover-scale shadow-xl">
                        Rejoindre la communauté
                    </button>
                </div>
            </div>

            <!-- Features Section -->
            <div class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Fonctionnalités</h2>
                        <p class="text-xl text-gray-600">Tout ce dont vous avez besoin pour communiquer efficacement</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-users text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Chat Public</h3>
                            <p class="text-gray-600">Discutez avec tous les membres de la communauté en temps réel</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-comment-dots text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Messages Privés</h3>
                            <p class="text-gray-600">Échangez en privé avec vos contacts préférés</p>
                        </div>
                        
                        <div class="text-center p-8 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-bolt text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-4">Temps Réel</h3>
                            <p class="text-gray-600">Recevez et envoyez des messages instantanément</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-gray-900 text-white mt-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <!-- Brand Section -->
                        <div class="col-span-1 lg:col-span-2">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                                    <i class="fas fa-comments text-white text-xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold">H7 Social</h3>
                            </div>
                            <p class="text-gray-300 max-w-md mb-6">
                                La plateforme de communication moderne qui connecte les utilisateurs en temps réel. 
                                Échangez, partagez et collaborez en toute simplicité.
                            </p>
                            <div class="flex space-x-4">
                                <a href="https://t.snapchat.com/XuhVH62f" target="_blank" rel="noopener noreferrer"
                                   class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center hover:bg-yellow-600 transition-colors">
                                    <i class="fab fa-snapchat-ghost text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                                    <i class="fab fa-facebook-f text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center hover:bg-pink-700 transition-colors">
                                    <i class="fab fa-instagram text-white"></i>
                                </a>
                                <a href="#" class="w-10 h-10 bg-blue-400 rounded-lg flex items-center justify-center hover:bg-blue-500 transition-colors">
                                    <i class="fab fa-twitter text-white"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Quick Links -->
                        <div>
                            <h4 class="text-lg font-semibold mb-4">Liens Rapides</h4>
                            <ul class="space-y-2">
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">À propos</a></li>
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Fonctionnalités</a></li>
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Support</a></li>
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Contact</a></li>
                            </ul>
                        </div>

                        <!-- Legal -->
                        <div>
                            <h4 class="text-lg font-semibold mb-4">Légal</h4>
                            <ul class="space-y-2">
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Confidentialité</a></li>
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Conditions</a></li>
                                <li><a href="#" class="text-gray-300 hover:text-white transition-colors">Cookies</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Bottom Border -->
                    <div class="border-t border-gray-800 mt-8 pt-8 text-center">
                        <p class="text-gray-400">&copy; 2024 H7 Social. Tous droits réservés.</p>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user text-white text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Rejoindre H7 Social</h2>
                    <p class="text-gray-600">Connectez-vous ou créez un compte pour commencer à discuter</p>
                </div>

                <div id="auth-tabs" class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button onclick="switchAuthTab('login')" 
                            class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm">
                        Connexion
                    </button>
                    <button onclick="switchAuthTab('register')" 
                            class="auth-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700">
                        Inscription
                    </button>
                </div>

                <form id="auth-form" onsubmit="handleAuth(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                            <input type="text" id="auth-username" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Votre nom d'utilisateur">
                        </div>
                        
                        <div id="password-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                            <input type="password" id="auth-password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Votre mot de passe">
                        </div>
                    </div>
                    
                    <button type="submit" id="auth-submit" class="w-full gradient-bg text-white py-3 px-4 rounded-lg mt-6 font-semibold">
                        Se connecter
                    </button>
                </form>

                <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden h-screen flex">
            <!-- Sidebar -->
            <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
                <!-- User Profile -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-4">
                        <div class="avatar-upload-container">
                            <div id="user-avatar" class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ?
                            </div>
                            <button onclick="triggerAvatarUpload()" class="avatar-upload-button">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="uploadAvatar(event)">
                        </div>
                        <div class="flex-1">
                            <h3 id="user-display-name" class="font-semibold text-gray-900">Utilisateur</h3>
                            <p class="text-sm text-gray-500">En ligne</p>
                        </div>
                        <button onclick="logoutUser()" class="text-gray-400 hover:text-red-500 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="p-4 border-b border-gray-200">
                    <div class="space-y-2">
                        <button onclick="showPublicChat()" id="public-chat-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center space-x-3 bg-blue-50 text-blue-600">
                            <i class="fas fa-users"></i>
                            <span>Chat Public</span>
                        </button>
                        <button onclick="showPrivateChats()" id="private-chats-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 flex items-center space-x-3">
                            <i class="fas fa-comment-dots"></i>
                            <span>Messages Privés</span>
                        </button>
                    </div>
                </div>

                <!-- Online Users / Private Chats -->
                <div class="flex-1 overflow-y-auto">
                    <!-- Online Users (for public chat) -->
                    <div id="online-users-section" class="p-4">
                        <h4 class="font-medium text-gray-900 mb-3">Utilisateurs en ligne</h4>
                        <div id="online-users-list" class="space-y-2">
                            <!-- Users will be populated here -->
                        </div>
                    </div>

                    <!-- Private Conversations -->
                    <div id="private-conversations-section" class="p-4 hidden">
                        <h4 class="font-medium text-gray-900 mb-3">Conversations</h4>
                        <div id="conversations-list" class="space-y-2">
                            <!-- Conversations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="bg-white border-b border-gray-200 p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 id="chat-title" class="text-xl font-semibold text-gray-900">Chat Public</h2>
                            <p id="chat-subtitle" class="text-sm text-gray-500">Discutez avec la communauté</p>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div id="messages-container" class="space-y-4">
                        <!-- Messages will be populated here -->
                    </div>
                </div>

                <!-- Message Input -->
                <div class="bg-white border-t border-gray-200 p-4">
                    <div class="flex space-x-4">
                        <input type="text" id="message-input" 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="Tapez votre message..."
                               onkeypress="handleMessageKeyPress(event)">
                        <button onclick="sendMessage()" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Global variables
        let app = null;
        let database = null;
        let storage = null;
        let currentUser = null;
        let currentChat = 'public';
        let currentPrivateChat = null;
        let messagesListeners = {};
        let isLogin = true;

        // Initialize Firebase
        function initFirebase(config) {
            try {
                app = initializeApp(config);
                database = getDatabase(app);
                storage = getStorage(app);
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showToast('Erreur de configuration Firebase: ' + error.message, 'error');
                return false;
            }
        }

        // Configuration management
        function loadFirebaseConfig() {
            const saved = localStorage.getItem('h7social_firebase_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('firebase-api-key').value = config.apiKey || '';
                    document.getElementById('firebase-db-url').value = config.databaseURL || '';
                    document.getElementById('firebase-project-id').value = config.projectId || '';
                    return config;
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            }
            return null;
        }

        function saveFirebaseConfig() {
            const apiKey = document.getElementById('firebase-api-key').value.trim();
            const databaseURL = document.getElementById('firebase-db-url').value.trim();
            const projectId = document.getElementById('firebase-project-id').value.trim();

            if (!apiKey || !databaseURL || !projectId) {
                showToast('Tous les champs sont requis', 'error');
                return;
            }

            const config = {
                apiKey: apiKey,
                authDomain: `${projectId}.firebaseapp.com`,
                databaseURL: databaseURL,
                projectId: projectId,
                storageBucket: `${projectId}.appspot.com`,
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abc123def456"
            };

            localStorage.setItem('h7social_firebase_config', JSON.stringify(config));
            
            if (initFirebase(config)) {
                toggleConfigPanel();
                showToast('Configuration sauvegardée avec succès!', 'success');
            }
        }

        function toggleConfigPanel() {
            const panel = document.getElementById('config-panel');
            panel.classList.toggle('hidden');
        }

        // User management
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function hashPassword(password) {
            // Simple hash function for demo purposes
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString();
        }

        async function handleAuth(event) {
            event.preventDefault();
            
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;
            
            if (!username) {
                showToast('Le nom d\'utilisateur est requis', 'error');
                return;
            }

            if (!isLogin && (!password || password.length < 4)) {
                showToast('Le mot de passe doit contenir au moins 4 caractères', 'error');
                return;
            }

            if (!database) {
                showToast('Veuillez configurer Firebase d\'abord', 'error');
                return;
            }

            try {
                if (isLogin) {
                    // Mode connexion - juste avec le nom d'utilisateur
                    const usersRef = ref(database, 'users');
                    const snapshot = await new Promise((resolve) => {
                        onValue(usersRef, resolve, { onlyOnce: true });
                    });

                    const users = snapshot.val() || {};
                    const userEntry = Object.entries(users).find(([id, user]) => 
                        user.username === username
                    );

                    if (!userEntry) {
                        showToast('Nom d\'utilisateur introuvable', 'error');
                        return;
                    }

                    const [userId, userData] = userEntry;
                    currentUser = { ...userData, id: userId };
                    
                    // Update last seen
                    await set(ref(database, `users/${userId}/lastSeen`), serverTimestamp());
                    
                    localStorage.setItem('h7social_current_user', JSON.stringify(currentUser));
                    
                    showToast('Connexion réussie!', 'success');
                    showMainApp();
                    closeAuthModal();
                    
                } else {
                    // Mode inscription - avec mot de passe
                    const usersRef = ref(database, 'users');
                    const snapshot = await new Promise((resolve) => {
                        onValue(usersRef, resolve, { onlyOnce: true });
                    });

                    const users = snapshot.val() || {};
                    const existingUser = Object.values(users).find(user => user.username === username);
                    
                    if (existingUser) {
                        showToast('Ce nom d\'utilisateur est déjà pris', 'error');
                        return;
                    }

                    // Create new user
                    const userId = generateUserId();
                    const hashedPassword = hashPassword(password);
                    
                    const userData = {
                        userId: userId,
                        username: username,
                        password: hashedPassword,
                        avatar: null,
                        createdAt: serverTimestamp(),
                        lastSeen: serverTimestamp()
                    };

                    await set(ref(database, `users/${userId}`), userData);
                    
                    currentUser = { ...userData, id: userId };
                    localStorage.setItem('h7social_current_user', JSON.stringify(currentUser));
                    
                    showToast('Compte créé avec succès!', 'success');
                    showMainApp();
                    closeAuthModal();
                }
                
            } catch (error) {
                console.error('Auth error:', error);
                showToast('Erreur d\'authentification: ' + error.message, 'error');
            }
        }

        function logoutUser() {
            if (currentUser && database) {
                // Remove from online users
                remove(ref(database, `online_users/${currentUser.id}`));
            }
            
            currentUser = null;
            localStorage.removeItem('h7social_current_user');
            
            // Clean up listeners
            Object.values(messagesListeners).forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            messagesListeners = {};
            
            showLandingPage();
            showToast('Déconnecté avec succès', 'success');
        }

        // Admin function to force disconnect a user
        async function forceDisconnectUser(userId) {
            if (!database || !currentUser) return;
            
            // Only allow admin H7 to disconnect users
            if (currentUser.username !== 'H7') {
                showToast('Accès non autorisé', 'error');
                return;
            }

            if (confirm('Êtes-vous sûr de vouloir déconnecter cet utilisateur?')) {
                try {
                    // Remove user from online users
                    await remove(ref(database, `online_users/${userId}`));
                    
                    // Optionally, you could also set a flag to force logout on their next action
                    await set(ref(database, `force_logout/${userId}`), {
                        timestamp: serverTimestamp(),
                        by: currentUser.username
                    });
                    
                    showToast('Utilisateur déconnecté avec succès', 'success');
                } catch (error) {
                    console.error('Error force disconnecting user:', error);
                    showToast('Erreur lors de la déconnexion forcée', 'error');
                }
            }
        }

        // UI Management
        function showLandingPage() {
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('user-display-name').textContent = currentUser.username;
                updateUserAvatar();
                
                // Set user as online
                if (database) {
                    set(ref(database, `online_users/${currentUser.id}`), {
                        username: currentUser.username,
                        avatar: currentUser.avatar,
                        timestamp: serverTimestamp()
                    });
                }
                
                // Start listening to messages and users
                setupMessageListeners();
                setupOnlineUsersListener();
            }
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-username').focus();
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            const passwordField = document.getElementById('password-field');
            const submitBtn = document.getElementById('auth-submit');
            
            tabs.forEach(t => {
                t.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                t.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            isLogin = tab === 'login';
            
            if (isLogin) {
                tabs[0].classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                tabs[0].classList.remove('text-gray-500', 'hover:text-gray-700');
                passwordField.classList.add('hidden');
                submitBtn.textContent = 'Se connecter';
            } else {
                tabs[1].classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                tabs[1].classList.remove('text-gray-500', 'hover:text-gray-700');
                passwordField.classList.remove('hidden');
                submitBtn.textContent = 'Créer un compte';
            }
        }

        // Chat management
        function showPublicChat() {
            currentChat = 'public';
            currentPrivateChat = null;
            
            document.getElementById('public-chat-btn').classList.add('bg-blue-50', 'text-blue-600');
            document.getElementById('private-chats-btn').classList.remove('bg-blue-50', 'text-blue-600');
            
            document.getElementById('online-users-section').classList.remove('hidden');
            document.getElementById('private-conversations-section').classList.add('hidden');
            
            document.getElementById('chat-title').textContent = 'Chat Public';
            document.getElementById('chat-subtitle').textContent = 'Discutez avec la communauté';
            
            setupMessageListeners();
        }

        function showPrivateChats() {
            currentChat = 'private';
            
            document.getElementById('private-chats-btn').classList.add('bg-blue-50', 'text-blue-600');
            document.getElementById('public-chat-btn').classList.remove('bg-blue-50', 'text-blue-600');
            
            document.getElementById('online-users-section').classList.add('hidden');
            document.getElementById('private-conversations-section').classList.remove('hidden');
            
            if (!currentPrivateChat) {
                document.getElementById('chat-title').textContent = 'Messages Privés';
                document.getElementById('chat-subtitle').textContent = 'Sélectionnez une conversation';
                document.getElementById('messages-container').innerHTML = '<div class="text-center text-gray-500 mt-8">Sélectionnez une conversation pour commencer à discuter</div>';
            }
            
            setupPrivateConversationsListener();
        }

        function startPrivateChat(userId, username) {
            if (!currentUser || userId === currentUser.id) return;
            
            const chatId = [currentUser.id, userId].sort().join('_');
            currentPrivateChat = { id: chatId, userId: userId, username: username };
            
            document.getElementById('chat-title').textContent = username;
            document.getElementById('chat-subtitle').textContent = 'Conversation privée';
            
            setupMessageListeners();
        }

        // Message handling
        async function sendMessage() {
            if (!database || !currentUser) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const messageData = {
                    text: message,
                    userId: currentUser.id,
                    username: currentUser.username,
                    avatar: currentUser.avatar,
                    timestamp: serverTimestamp()
                };
                
                let messagesRef;
                if (currentChat === 'public') {
                    messagesRef = ref(database, 'public_messages');
                } else if (currentPrivateChat) {
                    messagesRef = ref(database, `private_messages/${currentPrivateChat.id}`);
                } else {
                    return;
                }
                
                await push(messagesRef, messageData);
                input.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Erreur lors de l\'envoi du message', 'error');
            }
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function setupMessageListeners() {
            // Clean up existing listeners
            Object.values(messagesListeners).forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            messagesListeners = {};
            
            if (!database) return;
            
            let messagesRef;
            if (currentChat === 'public') {
                messagesRef = ref(database, 'public_messages');
            } else if (currentPrivateChat) {
                messagesRef = ref(database, `private_messages/${currentPrivateChat.id}`);
            } else {
                return;
            }
            
            const unsubscribe = onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val() || {};
                displayMessages(Object.entries(messages).map(([id, msg]) => ({id, ...msg})));
            });
            
            messagesListeners[currentChat === 'public' ? 'public' : currentPrivateChat.id] = unsubscribe;
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages-container');
            
            // Sort messages by timestamp
            messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            container.innerHTML = messages.map(msg => {
                const isOwn = msg.userId === currentUser?.id;
                const avatarHtml = msg.avatar 
                    ? `<img src="${msg.avatar}" class="w-8 h-8 rounded-full object-cover" alt="${msg.username}">`
                    : `<div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center text-white text-sm font-bold">${msg.username?.charAt(0).toUpperCase()}</div>`;
                
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';
                
                return `
                    <div class="chat-message flex ${isOwn ? 'justify-end' : 'justify-start'} space-x-3">
                        ${!isOwn ? `<div class="flex-shrink-0">${avatarHtml}</div>` : ''}
                        <div class="max-w-xs lg:max-w-md ${isOwn ? 'order-1' : ''}">
                            ${!isOwn ? `<div class="text-sm font-medium text-gray-900 mb-1">${msg.username}</div>` : ''}
                            <div class="${isOwn ? 'bg-blue-500 text-white' : 'bg-white'} rounded-lg px-4 py-2 shadow">
                                ${msg.text}
                            </div>
                            <div class="text-xs text-gray-500 mt-1 ${isOwn ? 'text-right' : ''}">${time}</div>
                        </div>
                        ${isOwn ? `<div class="flex-shrink-0">${avatarHtml}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function setupOnlineUsersListener() {
            if (!database) return;
            
            const onlineUsersRef = ref(database, 'online_users');
            onValue(onlineUsersRef, (snapshot) => {
                const onlineUsers = snapshot.val() || {};
                displayOnlineUsers(Object.entries(onlineUsers).map(([id, user]) => ({id, ...user})));
            });
        }

        function displayOnlineUsers(users) {
            const container = document.getElementById('online-users-list');
            
            container.innerHTML = users
                .filter(user => user.id !== currentUser?.id)
                .map(user => {
                    const avatarHtml = user.avatar 
                        ? `<img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover" alt="${user.username}">`
                        : `<div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center text-white text-sm font-bold">${user.username?.charAt(0).toUpperCase()}</div>`;
                    
                    // Show admin disconnect button only for H7 admin
                    const adminButton = (currentUser?.username === 'H7') ? 
                        `<button onclick="forceDisconnectUser('${user.id}')" class="admin-disconnect-btn ml-2">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>` : '';
                    
                    return `
                        <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded-lg cursor-pointer" onclick="startPrivateChat('${user.id}', '${user.username}')">
                            <div class="flex items-center space-x-3">
                                ${avatarHtml}
                                <div>
                                    <div class="font-medium text-gray-900">${user.username}</div>
                                    <div class="text-sm text-green-500 flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        En ligne
                                    </div>
                                </div>
                            </div>
                            ${adminButton}
                        </div>
                    `;
                }).join('');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Aucun utilisateur en ligne</div>';
            }
        }

        function setupPrivateConversationsListener() {
            // This would typically load recent private conversations
            // For now, we'll keep it simple and show that functionality exists
            const container = document.getElementById('conversations-list');
            container.innerHTML = '<div class="text-center text-gray-500 py-4">Vos conversations apparaîtront ici</div>';
        }

        // Avatar management
        function updateUserAvatar() {
            const avatarElement = document.getElementById('user-avatar');
            if (currentUser?.avatar) {
                avatarElement.innerHTML = `<img src="${currentUser.avatar}" class="w-12 h-12 rounded-full object-cover" alt="${currentUser.username}">`;
            } else {
                avatarElement.innerHTML = currentUser?.username?.charAt(0).toUpperCase() || '?';
            }
        }

        function triggerAvatarUpload() {
            document.getElementById('avatar-upload').click();
        }

        async function uploadAvatar(event) {
            if (!storage || !currentUser) return;
            
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Veuillez sélectionner une image', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showToast('L\'image ne doit pas dépasser 5MB', 'error');
                return;
            }
            
            try {
                const avatarRef = storageRef(storage, `avatars/${currentUser.id}`);
                const snapshot = await uploadBytes(avatarRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Update user avatar in database
                await set(ref(database, `users/${currentUser.id}/avatar`), downloadURL);
                
                // Update current user object
                currentUser.avatar = downloadURL;
                localStorage.setItem('h7social_current_user', JSON.stringify(currentUser));
                
                // Update UI
                updateUserAvatar();
                
                showToast('Avatar mis à jour avec succès!', 'success');
                
            } catch (error) {
                console.error('Avatar upload error:', error);
                showToast('Erreur lors du téléchargement de l\'avatar', 'error');
            }
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Make functions globally available
        window.saveFirebaseConfig = saveFirebaseConfig;
        window.toggleConfigPanel = toggleConfigPanel;
        window.handleAuth = handleAuth;
        window.logoutUser = logoutUser;
        window.forceDisconnectUser = forceDisconnectUser;
        window.showAuthModal = showAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.switchAuthTab = switchAuthTab;
        window.showPublicChat = showPublicChat;
        window.showPrivateChats = showPrivateChats;
        window.startPrivateChat = startPrivateChat;
        window.sendMessage = sendMessage;
        window.handleMessageKeyPress = handleMessageKeyPress;
        window.triggerAvatarUpload = triggerAvatarUpload;
        window.uploadAvatar = uploadAvatar;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved Firebase config
            const savedConfig = loadFirebaseConfig();
            if (savedConfig) {
                initFirebase(savedConfig);
            }
            
            // Check for existing user session
            const savedUser = localStorage.getItem('h7social_current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (database) {
                        showMainApp();
                    }
                } catch (error) {
                    console.error('Error loading saved user:', error);
                    localStorage.removeItem('h7social_current_user');
                }
            }
        });

    </script>
</body>
</html>
